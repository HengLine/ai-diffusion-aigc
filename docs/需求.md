调教AI的需求，后期优化添加的需求：



# 我的需求

## 需求一：

需要在“我的任务”按钮上，显示数字小标识，数字为统计今天未完成（运行中、排队中）的任务数量，遵循以下3个要求：

1. 如果用户选择对应的菜单（文生图，图生图，文生视频，图生视频），那只统计对应类型的未完成数。
2. 如果选择除此之外的其他菜单， 数字显示应该是今天未完成的所有任务。
3. 选择对应菜单后需要高亮当前菜单。



## ~~需求二~~：

> ~~当服务重启后，你需要添加一个监听器，去异步监控最近两天未完成状态的所有任务（筛选提交任务日期是当前时间之前的）。~~
>
> ~~然后去调用 comfyui 的接口查看执行状态。当发生以下3种情况后，就结束监控任务，否则持续监控，直到所有任务完成为止。~~
>
> 1. ~~当状态为 "排队中"，就把这些任务加入到队列任务池中。~~
> 2. ~~当状态为"运行中"，你需要调用 comfyui  api 结果查询接口~~
>    1. ~~如果 comfyui 中该任务执行已经完成，你需要将任务结果数据更新并将结果存储在指定位置。~~
>    2. ~~如果 comfyui 中该任务没有完成，且执行时长已经超过2小时了，那就停止对该任务的监控，并更新数据，标记为“失败”状态，并给出说明。否则就持续定时跟进。~~



## 需求三：

当任务提交后，你需要显示任务池的状态，包括：预计等待时长（时间线显示），排队状态，友好的用户提示语。



## **==需求四==**：

任务状态的变更，之前是用定时任务调用接口的方式，现要求改为 websocket 方式，当任务完成后，刷新任务状态、未完成任务的统计数、在结果中展示任务结果等。



## 需求五：

1.我的任务界面添加状态和类型筛选。 

2.图生图和文生视频界面的参数，显示结果放在选择框之后，而不是放在下一行，参考文生图界面



## 需求六：

所有提交任务异常后，右下角弹框提示，显示三秒后消失，包括参数校验提示。不要在页面中出现alert弹框

## 需求七：

1.配置中添加用户邮箱、昵称等信息。

2.配置界面的用户信息下方，分不同的tab也，添加不同类型（文生图，图生图，文生视频，图生视频）对应的模型参数，可以让用户修改默认值，如：输出图片控制、步数等，提供接口 修改 config.json 中 settings 节点对应的类型参数。



## **需求八**：

任务提交后，在队列中取出消费，若发现comfyui工作流连接异常，则将任务加入到本地任务记录中，并标记为“异常”状态，添加一个 task_msg 字段，内容为 “ComfyUI 工作流连接超时”。

> 1. ~~3分钟后从任务记录中取出第一个“排队中”的任务尝试，只取出一个任务，连续重试三次，间隔30秒，若依旧无法连接到comfyui，此继续下一步。~~
>
> 2. ~~10分钟后继续从任务记录中取出第一个“排队中”的任务尝试，只取出一个任务，连续重试三次，间隔30秒，若依旧无法连接到comfyui时，此继续下一步。~~
>
> 3. ~~30分钟后继续从任务记录中取出第一个“排队中”的任务尝试，只取出一个任务，连续重试三次，间隔30秒，依旧无法连接到comfyui时，不再继续。~~
>
> 4. ~~三阶段尝试后，仍旧无法连接，给用户邮箱发提示信息，告警comfyui 异常，请检查。~~
>
> 5. ~~如果任务记录中已经没有“排队中”状态的数据，则结束定时任务。~~
>
> 6. ~~如果在某一次尝试后，comfyui连接正常了，就取出任务记录中所有 “排队中” 状态的任务，按日期顺序加入队列中，等待执行。~~



## 需求九：

服务启动后创建一个定时器，定期从今天的任务记录中获取执行次数不超过3的以下状态的任务（每30秒执行一次）。


1. 当状态为 "失败"，就把这些任务按顺序加入到队列任务池中，并将执行次数加1。
2. 当状态为"运行中"，你需要调用 comfyui  api 结果查询接口
   1. 如果 comfyui 中该任务执行已经完成，你需要将任务结果数据更新并将结果存储在指定位置。
   2. 如果 comfyui 中该任务没有完成，且执行时长已经超过2小时了，那就停止对该任务的监控，并更新数据，标记为“失败”状态，并给出说明。否则就持续定时跟进。
3. 所有任务执行次数超过3次就不再执行，记为“失败”，失败信息为“执行失败，重试超过3次”



## 需求十：

当服务宕机或关机时，将队列中排队的任务，全部按顺序写入任务记录中，任务状态为“排队中”

~~任务状态为“失败”，失败信息为“服务异常宕机，任务将在恢复后重新开始执行”~~



## ~~需求十一~~：

~~我的任务界面添加  “继续任务” 按钮，用于触发所有未完成的任务，继续执行 ，如果任务在“执行中”状态，就先查询comfyui的结果，返回结果的直接更新状态和数据就可。~~

~~注意：取出任务时，需要考虑并发情况。~~



## 需求十二

- 给任务记录添加一个执行次数字段，默认都为0，当状态转“运行中”一次，该值就加1。
- 任务记录中的 task_id 必须保证唯一，如果有相同的存在就更新之前的数据

- 当服务启动时，加载今天任务记录中所有“排队中”的任务。把这些任务按顺序加入到队列任务池中。





