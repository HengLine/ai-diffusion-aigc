<!-- 任务队列状态组件 -->
<div id="queueStatusContainer" class="queue-status" style="display: none;">
    <h3>任务队列状态</h3>
    <div id="queueStatus"></div>
    <div class="task-progress">
        <div class="task-progress-bar">
            <div class="task-progress-fill"></div>
            <div class="task-progress-text">等待中</div>
        </div>
    </div>
</div>

<script>
// 任务队列状态轮询逻辑
let pollingInterval = null;

function startQueueStatusPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
    
    pollingInterval = setInterval(updateQueueStatus, 5000); // 每5秒更新一次
    
    // 立即执行一次
    updateQueueStatus();
}

function stopQueueStatusPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

function updateQueueStatus() {
    // 获取当前页面的任务类型
    let taskType = 'all';
    if (typeof getCurrentTaskType === 'function') {
        taskType = getCurrentTaskType();
    }
    
    // 构建请求URL，根据任务类型添加参数
    let url = '/api/task_queue/status';
    if (taskType !== 'all') {
        url += `?task_type=${taskType}`;
    }
    
    // 发送实际API请求
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP错误!状态码: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('任务队列API响应:', data);
            
            const queueStatusContainer = document.getElementById('queueStatusContainer');
            const queueStatus = document.getElementById('queueStatus');
            const taskProgressFill = document.querySelector('.task-progress-fill');
            const taskProgressText = document.querySelector('.task-progress-text');
            const queueTaskBadge = document.getElementById('queueTaskBadge');
            
            // 检查数据结构是否正确
            const queueData = data.success && data.data ? data.data : {};
            
            // 更新任务计数徽章
            if (queueTaskBadge) {
                // 使用unfinished_tasks_count作为徽章显示值，这是包含所有历史和当前任务的更准确计数
                const displayCount = queueData.unfinished_tasks_count || queueData.total_tasks || 0;
                // 始终显示徽章，确保用户知道有任务系统
                queueTaskBadge.style.display = 'inline-block';
                queueTaskBadge.textContent = displayCount;
            }
            
            if (queueData.in_queue && queueData.in_queue > 0 || queueData.total_tasks && queueData.total_tasks > 0) {
                // 有排队任务或执行中任务，显示队列状态
                if (queueStatusContainer) {
                    queueStatusContainer.style.display = 'block';
                }
                
                if (queueStatus) {
                    const position = queueData.position || 0;
                    const total = queueData.in_queue || 0;
                    const estimatedTime = queueData.estimated_time || 0;
                    
                    // 确保显示状态信息
                    queueStatus.innerHTML = `
                        <p>当前队列位置: ${position}/${total}</p>
                        <p>预计等待时间: ${estimatedTime} 分钟</p>
                        <p>执行中任务: ${queueData.running_tasks || 0}</p>
                        <p>总任务数: ${queueData.total_tasks || 0}</p>
                    `;
                }
                
                if (taskProgressFill && taskProgressText) {
                    const progress = queueData.progress || 0;
                    taskProgressFill.style.width = `${progress}%`;
                    taskProgressText.textContent = progress > 0 ? `${progress}%` : '等待中';
                }
            } else if (queueStatusContainer) {
                // 没有排队任务，隐藏队列状态
                queueStatusContainer.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('更新任务队列状态失败:', error);
            
            // API请求失败时，保持队列状态显示
            const queueStatusContainer = document.getElementById('queueStatusContainer');
            const queueStatus = document.getElementById('queueStatus');
            const queueTaskBadge = document.getElementById('queueTaskBadge');
            
            if (queueTaskBadge) {
                // 即使API失败，也显示一个可能的任务数
                queueTaskBadge.style.display = 'inline-block';
                queueTaskBadge.textContent = '?';
            }
            
            if (queueStatusContainer && queueStatus) {
                queueStatusContainer.style.display = 'block';
                queueStatus.innerHTML = '<p style="color: #dc3545;">无法连接到服务器，请稍后刷新页面重试</p>';
            }
        });
}


function openTaskStatusModal(data) {
    try {
        // 获取DOM元素
        const queueStatusContainer = document.getElementById('queueStatusContainer');
        const queueStatus = document.getElementById('queueStatus');
        const taskProgressFill = document.querySelector('.task-progress-fill');
        const taskProgressText = document.querySelector('.task-progress-text');
        const queueTaskBadge = document.getElementById('queueTaskBadge');
        
        // 如果没有传入数据，使用默认数据
        const taskData = data || {
            total_tasks: 0,
            in_queue: 0,
            position: 0,
            estimated_time: 0,
            progress: 0
        };
        
        // 更新任务计数徽章
        if (queueTaskBadge) {
            // 始终显示徽章，确保用户知道有任务系统
            queueTaskBadge.style.display = 'inline-block';
            queueTaskBadge.textContent = taskData.total_tasks || 0;
        }
        
        // 有排队任务，显示队列状态
        if (queueStatusContainer) {
            queueStatusContainer.style.display = 'block';
        }
        
        if (queueStatus) {
            const position = taskData.position || 0;
            const total = taskData.in_queue || 0;
            const estimatedTime = taskData.estimated_time || 0;
            
            // 如果是模拟数据，显示模拟的任务队列信息
            if (!data) {
                queueStatus.innerHTML = `
                    <p>任务队列演示</p>
                    <p>当前队列位置: 模拟数据</p>
                    <p>预计等待时间: 模拟数据</p>
                `;
            } else {
                queueStatus.innerHTML = `
                    <p>当前队列位置: ${position}/${total}</p>
                    <p>预计等待时间: ${estimatedTime} 分钟</p>
                `;
            }
        }
        
        if (taskProgressFill && taskProgressText) {
            const progress = taskData.progress || 0;
            taskProgressFill.style.width = `${progress}%`;
            taskProgressText.textContent = progress > 0 ? `${progress}%` : '等待中';
        }
    } catch (error) {
        console.error('打开任务状态模态框失败:', error);
        
        // 显示错误信息
        const queueStatusContainer = document.getElementById('queueStatusContainer');
        const queueStatus = document.getElementById('queueStatus');
        
        if (queueStatusContainer && queueStatus) {
            queueStatusContainer.style.display = 'block';
            queueStatus.innerHTML = `<p style="color: #dc3545;">无法获取队列状态，请刷新页面重试</p>`;
        }
    }
}


// 页面卸载时停止轮询
window.addEventListener('beforeunload', function() {
    stopQueueStatusPolling();
});

// 页面加载完成后自动启动轮询
document.addEventListener('DOMContentLoaded', function() {
    // 延迟一小段时间启动轮询，确保页面其他元素已经加载完成
    setTimeout(startQueueStatusPolling, 1000);
});
</script>