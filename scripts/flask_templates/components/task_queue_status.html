<!-- 任务队列状态组件 -->
<div id="queueStatusContainer" class="queue-status" style="display: none;">
    <h3>任务队列状态</h3>
    <div id="queueStatus"></div>
    <div class="task-progress">
        <div class="task-progress-bar">
            <div class="task-progress-fill"></div>
            <div class="task-progress-text">等待中</div>
        </div>
    </div>
</div>

<script>
// 任务队列状态轮询逻辑
let pollingInterval = null;

function startQueueStatusPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
    
    pollingInterval = setInterval(updateQueueStatus, 3000); // 每3秒更新一次
    
    // 立即执行一次
    updateQueueStatus();
}

function stopQueueStatusPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

function updateQueueStatus() {
    fetch('/api/task_queue/status')
        .then(response => response.json())
        .then(data => {
            const queueStatusContainer = document.getElementById('queueStatusContainer');
            const queueStatus = document.getElementById('queueStatus');
            const taskProgressFill = document.querySelector('.task-progress-fill');
            const taskProgressText = document.querySelector('.task-progress-text');
            const queueTaskCount = document.getElementById('queueTaskCount');
            const queueTaskBadge = document.getElementById('queueTaskBadge');
            
            if (queueTaskCount) {
                queueTaskCount.textContent = data.total_tasks || 0;
            }
            
            if (queueTaskBadge) {
                if (data.total_tasks && data.total_tasks > 0) {
                    queueTaskBadge.style.display = 'inline-block';
                    queueTaskBadge.textContent = data.total_tasks;
                } else {
                    queueTaskBadge.style.display = 'none';
                }
            }
            
            if (data.in_queue && data.in_queue > 0) {
                // 有排队任务，显示队列状态
                if (queueStatusContainer) {
                    queueStatusContainer.style.display = 'block';
                }
                
                if (queueStatus) {
                    const position = data.position || 0;
                    const total = data.in_queue || 0;
                    const estimatedTime = data.estimated_time || 0;
                    
                    queueStatus.innerHTML = `
                        <p>当前队列位置: ${position}/${total}</p>
                        <p>预计等待时间: ${estimatedTime} 分钟</p>
                    `;
                }
                
                if (taskProgressFill && taskProgressText) {
                    const progress = data.progress || 0;
                    taskProgressFill.style.width = `${progress}%`;
                    taskProgressText.textContent = progress > 0 ? `${progress}%` : '等待中';
                }
            } else if (queueStatusContainer) {
                // 没有排队任务，隐藏队列状态
                queueStatusContainer.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('更新任务队列状态失败:', error);
        });
}


 function openTaskStatusModal() {
    try {
        if (waitingTasks > 0) {
            // 更新任务计数
            taskCountElement.textContent = '有任务';
            taskBadgeElement.textContent = waitingTasks;
            taskBadgeElement.style.display = 'inline-block';
            
            // 计算预计等待时间
            const avgDurations = queueData.average_task_durations || {};
            const avgImageToImageDuration = avgDurations.image_to_image || 70; // 秒
            const estimatedWaitTimeMinutes = Math.ceil((waitingTasks * avgImageToImageDuration) / 60);
            
            // 更新队列状态信息
            queueStatus.innerHTML = `
                <p>当前有 ${runningTasks} 个任务正在处理</p>
                <p>您的任务排在第 ${waitingTasks} 位</p>
                <p>预计需要等待约 ${estimatedWaitTimeMinutes} 分钟</p>
            `;
            
            // 更新进度条
            const progressPercentage = Math.max(0, Math.min(100, 100 - (waitingTasks * 10)));
            progressFill.style.width = `${progressPercentage}%`;
            progressText.textContent = `排队中 (${progressPercentage}%)`;
            progressText.style.color = '#2c3e50';
        } else {
            // 没有任务在排队
            if (runningTasks > 0) {
                taskCountElement.textContent = '有任务';
                taskBadgeElement.style.display = 'none';
                
                // 更新队列状态信息
                queueStatus.innerHTML = `
                    <p>当前有 ${runningTasks} 个任务正在处理</p>
                    <p>您的任务将在队列空闲后立即开始</p>
                `;
                
                // 更新进度条
                progressFill.style.width = '100%';
                progressFill.style.backgroundColor = '#007bff'; // 蓝色表示准备中
                progressText.textContent = '准备中';
                progressText.style.color = 'white';
            } else {
                taskCountElement.textContent = '0';
                taskBadgeElement.style.display = 'none';
                
                // 更新队列状态信息
                queueStatus.innerHTML = `
                    <p>当前队列为空</p>
                    <p>您的任务将立即开始处理</p>
                `;
                
                // 更新进度条
                progressFill.style.width = '100%';
                progressFill.style.backgroundColor = '#28a745'; // 绿色表示完成
                progressText.textContent = '就绪';
                progressText.style.color = 'white';
            }
        }
    } catch (error) {
        console.error('获取任务队列状态失败:', error);
        
        // 显示错误信息
        const queueStatusContainer = document.getElementById('queueStatusContainer');
        const queueStatus = document.getElementById('queueStatus');
        
        queueStatusContainer.style.display = 'block';
        queueStatus.innerHTML = `<p style="color: #dc3545;">无法获取队列状态，请刷新页面重试</p>`;
    }
}


// 页面卸载时停止轮询
window.addEventListener('beforeunload', function() {
    stopQueueStatusPolling();
});
</script>