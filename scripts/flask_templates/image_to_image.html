<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图生图 - AIGC创意平台</title>
    <style>
        /* 导航栏样式 */
        nav {
            background-color: #4a6fa5;
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .nav-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-brand {
            font-size: 1.5rem;
            font-weight: 700;
            text-decoration: none;
            color: white;
        }
        
        .nav-menu {
            display: flex;
            gap: 1.5rem;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .nav-item a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.3s ease;
        }
        
        .nav-item a:hover {
            opacity: 0.8;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .task-indicator {
            position: relative;
        }
        
        .task-count {
            background-color: #dc3545;
            color: white;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 10px;
            position: absolute;
            top: -5px;
            right: -5px;
            font-weight: 600;
        }
        
        .my-tasks-button {
            background-color: #ffffff;
            color: #4a6fa5;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        
        .my-tasks-button:hover {
            background-color: #f8f9fa;
        }
        
        /* 移动端导航菜单 */
        .mobile-menu-button {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background-color: #4a6fa5;
                flex-direction: column;
                padding: 1rem 0;
                margin-top: 0.5rem;
                border-radius: 0 0 8px 8px;
            }
            
            .nav-menu.show {
                display: flex;
            }
            
            .mobile-menu-button {
                display: block;
            }
            
            .nav-container {
                position: relative;
                flex-wrap: wrap;
            }
        }
    
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
            background-color: #f5f5f5;
        }
        header {
            background-color: #4a6fa5;
            color: white;
            padding: 1.5rem 0;
            text-align: center;
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        header h1 {
            margin: 0;
            font-size: 2rem;
        }
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            font-family: inherit;
            min-height: 100px;
            box-sizing: border-box;
            resize: vertical;
        }
        .form-group textarea:focus {
            outline: none;
            border-color: #4a6fa5;
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }
        .form-group input[type="file"] {
            display: block;
            margin-top: 0.5rem;
        }
        .file-input {
            position: relative;
            display: inline-block;
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .file-input:hover {
            background-color: #e9ecef;
        }
        .file-input input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .file-name {
            display: inline-block;
            margin-left: 0.5rem;
            font-style: italic;
            color: #6c757d;
        }
        .form-button {
            background-color: #4a6fa5;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .form-button:hover {
            background-color: #3a5a85;
        }
        .back-link {
            display: inline-block;
            margin-top: 1rem;
            color: #4a6fa5;
            text-decoration: none;
            font-weight: 500;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .status-box {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        .queue-status {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        .queue-status h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #495057;
            font-size: 1.1rem;
        }
        .queue-status p {
            margin: 5px 0;
            color: #6c757d;
        }
        .task-progress {
            margin-top: 15px;
        }
        .task-progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        .task-progress-fill {
            height: 100%;
            background-color: #4a6fa5;
            transition: width 0.3s ease;
        }
        .task-progress-text {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2c3e50;
            font-weight: 500;
        }
        .tips {
            background-color: #fff3cd;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #ffc107;
        }
        .tips h3 {
            margin-top: 0;
            color: #856404;
        }
        .tips ul {
            margin-bottom: 0;
            padding-left: 1.5rem;
        }
        .tips li {
            margin-bottom: 0.5rem;
        }
        /* 预览区域 */
        .preview-container {
            display: none;
            margin-top: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            background-color: #f8f9fa;
        }
        .preview-container.show {
            display: block;
        }
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            display: block;
            margin: 0 auto;
            border-radius: 4px;
        }
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }
        }
    </style>
    <script>
            // 确保文件选择预览功能正常工作
            function setupFilePreview() {
                // 文件选择预览功能
                const fileInput = document.getElementById('image');
                const previewContainer = document.querySelector('.preview-container');
                const previewImage = document.querySelector('.preview-image');
                const fileName = document.querySelector('.file-name');
                
                // 确保元素存在
                if (!fileInput || !previewContainer || !previewImage || !fileName) {
                    console.error('无法找到图片上传相关的DOM元素');
                    return;
                }
                
                // 移除已存在的监听器（避免重复绑定）
                const newFileInput = fileInput.cloneNode(true);
                fileInput.parentNode.replaceChild(newFileInput, fileInput);
                
                // 重新绑定事件
                newFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // 显示文件名
                        fileName.textContent = file.name;
                        
                        // 预览图片
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            previewImage.src = event.target.result;
                            previewContainer.classList.add('show');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        fileName.textContent = '';
                        previewContainer.classList.remove('show');
                    }
                });
            }
            
            document.addEventListener('DOMContentLoaded', function() {
                setupFilePreview();
            });
        </script>
</head>
<body>
    <!-- 导航栏 -->
    <nav>
        <div class="nav-container">
            <a href="{{ url_for('index') }}" class="nav-brand">AIGC创意平台</a>
            
            <button class="mobile-menu-button" onclick="toggleMobileMenu()">☰</button>
            
            <ul class="nav-menu" id="navMenu">
                <li class="nav-item"><a href="{{ url_for('index') }}">首页</a></li>
                <li class="nav-item"><a href="{{ url_for('text_to_image.text_to_image') }}">文生图</a></li>
                <li class="nav-item"><a href="{{ url_for('image_to_image.image_to_image') }}">图生图</a></li>
                <li class="nav-item"><a href="{{ url_for('text_to_video.text_to_video') }}">文生视频</a></li>
                <li class="nav-item"><a href="{{ url_for('image_to_video.image_to_video') }}">图生视频</a></li>
            </ul>
            
            <div class="nav-right">
                <div class="task-indicator">
                    <span id="queueTaskCount">0</span>
                    <span class="task-count" id="queueTaskBadge" style="display: none;">0</span>
                </div>
                <button class="my-tasks-button" onclick="openTaskModal()">我的任务</button>
            </div>
        </div>
    </nav>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="status-box status-{{ category }}">
                        <p>{{ message }}</p>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="tips">
            <h3>图生图指南</h3>
            <ul>
                <li>上传一张清晰的图片作为基础</li>
                <li>编写提示词来引导图像转换</li>
                <li>提示词应包括想要保留的元素和新增的风格</li>
                <li>支持的图片格式：PNG、JPG、JPEG、GIF</li>
            </ul>
        </div>

        <form method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="image">上传图片 (必填)</label>
                <div class="file-input">
                    选择文件
                    <input type="file" id="image" name="image" accept="image/*">
                </div>
                <span class="file-name"></span>
                <div class="preview-container">
                    <img class="preview-image" src="" alt="图片预览">
                </div>
            </div>
            
            <div class="form-group">
                <label for="prompt">提示词 (必填)</label>
                <textarea id="prompt" name="prompt" placeholder="请输入图像转换指令，例如：convert to oil painting style, vibrant colors, high detail"></textarea>
            </div>
            
            <div class="form-group">
                <label for="negative_prompt">负面提示词</label>
                <textarea id="negative_prompt" name="negative_prompt" placeholder="请输入不想要的效果">{{ default_params.negative_prompt or 'low quality, blurry, bad anatomy, extra limbs, disfigured, worst quality, lowres' }}</textarea>
            </div>
            
            <!-- 添加缺失的表单字段 -->
            <div class="form-group">
                <label for="strength">转换强度 (0-1)</label>
                <input type="number" id="strength" name="strength" min="0" max="1" step="0.1" value="{{ default_params.strength or 0.6 }}">
                <small>值越低保留原图特征越多，值越高变化越大</small>
            </div>
            
            <div class="form-group">
                <label for="steps">生成步数</label>
                <input type="number" id="steps" name="steps" min="5" max="100" value="{{ default_params.steps or 30 }}">
                <small>步数越多，细节越丰富，但生成时间越长</small>
            </div>
            
            <div class="form-group">
                <label for="cfg_scale">CFG Scale</label>
                <input type="number" id="cfg_scale" name="cfg_scale" min="1" max="30" step="0.5" value="{{ default_params.cfg or 8.0 }}">
                <small>值越高，越严格遵循提示词</small>
            </div>
            
            <div class="form-group">
                <label for="width">输出宽度 (像素)</label>
                <input type="number" id="width" name="width" min="128" max="2048" step="16" value="{{ default_params.width or 512 }}">
                <small>建议值：512, 768, 1024</small>
            </div>
            
            <div class="form-group">
                <label for="height">输出高度 (像素)</label>
                <input type="number" id="height" name="height" min="128" max="2048" step="16" value="{{ default_params.height or 512 }}">
                <small>建议值：512, 768, 1024</small>
            </div>
            
            <button type="submit" class="form-button" id="generateButton">生成图像</button>
            <div id="loadingIndicator" style="display: none; margin-top: 10px; color: #4a6fa5;">
                <div style="display: flex; align-items: center;">
                    <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #4a6fa5; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span style="margin-left: 10px;">正在生成图像，请稍候...</span>
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // 防止重复点击功能
                    const generateButton = document.getElementById('generateButton');
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    const form = document.querySelector('form');
                    
                    form.addEventListener('submit', function(e) {
                        e.preventDefault(); // 阻止默认表单提交
                        
                        // 检查必填项
                        const imageFile = document.getElementById('image').files[0];
                        const prompt = document.getElementById('prompt').value;
                        
                        if (!imageFile) {
                            alert('请上传一张图片！');
                            return;
                        }
                        
                        if (!prompt.trim()) {
                            alert('请输入提示词！');
                            return;
                        }
                        
                        // 禁用按钮防止重复点击
                        generateButton.disabled = true;
                        generateButton.textContent = '生成中...';
                        // 显示加载指示器
                        loadingIndicator.style.display = 'block';
                        
                        // 准备表单数据
                        const formData = new FormData(form);
                        
                        // 异步提交表单
                        fetch('/api/image_to_image', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // 显示自动关闭的成功提示
                                showAutoCloseNotification('任务提交成功，请在"我的任务"中查看进度', 2000);
                                // 刷新任务队列状态
                                updateQueueStatus();
                            } else {
                                alert(data.message || '生成失败，请重试');
                            }
                            
                            // 恢复按钮状态
                            generateButton.disabled = false;
                            generateButton.textContent = '生成图像';
                            loadingIndicator.style.display = 'none';
                        })
                        .catch(error => {
                            console.error('请求失败:', error);
                            alert('生成请求失败，请重试');
                            
                            // 恢复按钮状态
                            generateButton.disabled = false;
                            generateButton.textContent = '生成图像';
                            loadingIndicator.style.display = 'none';
                        });
                    });
                });
                
                // 添加加载动画样式
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            </script>
        </form>

        <a href="{{ url_for('index') }}" class="back-link">← 返回首页</a>
        
        <!-- 任务队列状态显示区域 -->
        <div id="queueStatusContainer" class="queue-status" style="display: none;">
            <h3>任务队列状态</h3>
            <div id="queueStatus"></div>
            <div class="task-progress">
                <div class="task-progress-bar">
                    <div class="task-progress-fill"></div>
                    <div class="task-progress-text">等待中</div>
                </div>
            </div>
        </div>
    </div>
    
        <script>
            // 移动端菜单切换功能
            function toggleMobileMenu() {
                const navMenu = document.getElementById('navMenu');
                navMenu.classList.toggle('show');
            }
            
            // 自动关闭通知函数
            function showAutoCloseNotification(message, duration = 2000) {
                // 检查通知元素是否存在，不存在则创建
                let notificationContainer = document.getElementById('notificationContainer');
                if (!notificationContainer) {
                    notificationContainer = document.createElement('div');
                    notificationContainer.id = 'notificationContainer';
                    notificationContainer.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 1000;
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    `;
                    document.body.appendChild(notificationContainer);
                }
                
                // 创建通知元素
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.style.cssText = `
                    background-color: #28a745;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 6px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    max-width: 300px;
                    opacity: 0;
                    transform: translateX(100%);
                    transition: opacity 0.3s ease, transform 0.3s ease;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    font-size: 14px;
                `;
                notification.textContent = message;
                
                // 添加到容器并显示
                notificationContainer.appendChild(notification);
                // 触发重排后应用过渡效果
                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateX(0)';
                }, 10);
                
                // 设置自动关闭
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    // 过渡结束后移除元素
                    setTimeout(() => {
                        if (notification.parentNode === notificationContainer) {
                            notificationContainer.removeChild(notification);
                        }
                        // 如果容器为空，也可以选择移除它
                        if (notificationContainer.children.length === 0) {
                            document.body.removeChild(notificationContainer);
                        }
                    }, 300);
                }, duration);
            }
            
            // 任务队列状态轮询逻辑
            let pollingInterval = null;
            
            function startQueueStatusPolling() {
                // 先停止现有的轮询
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
                
                // 立即执行一次查询
                updateQueueStatus();
                
                // 设置轮询间隔 (每3秒一次)
                pollingInterval = setInterval(updateQueueStatus, 3000);
            }
            
            async function updateQueueStatus() {
                try {
                    const response = await fetch('/api/task_queue/status');
                    const data = await response.json();
                    
                    // 确保数据结构正确
                    if (!data.success || !data.data) {
                        throw new Error('无效的API响应');
                    }
                    
                    const queueData = data.data;
                    // 使用正确的字段名
                    const runningTasks = queueData.running_tasks_count || 0;
                    const waitingTasks = queueData.queued_tasks_count || 0;
                    const totalTasks = runningTasks + waitingTasks;
                    
                    // 更新任务计数
                    const taskCountElement = document.getElementById('queueTaskCount');
                    const taskBadgeElement = document.getElementById('queueTaskBadge');
                    const queueStatusContainer = document.getElementById('queueStatusContainer');
                    const queueStatus = document.getElementById('queueStatus');
                    const progressFill = document.querySelector('.task-progress-fill');
                    const progressText = document.querySelector('.task-progress-text');
                    
                    // 显示队列状态容器，无论是否有任务排队
                    queueStatusContainer.style.display = 'block';
                    
                    if (waitingTasks > 0) {
                        // 更新任务计数
                        taskCountElement.textContent = '有任务';
                        taskBadgeElement.textContent = waitingTasks;
                        taskBadgeElement.style.display = 'inline-block';
                        
                        // 计算预计等待时间
                        const avgDurations = queueData.average_task_durations || {};
                        const avgImageToImageDuration = avgDurations.image_to_image || 70; // 秒
                        const estimatedWaitTimeMinutes = Math.ceil((waitingTasks * avgImageToImageDuration) / 60);
                        
                        // 更新队列状态信息
                        queueStatus.innerHTML = `
                            <p>当前有 ${runningTasks} 个任务正在处理</p>
                            <p>您的任务排在第 ${waitingTasks} 位</p>
                            <p>预计需要等待约 ${estimatedWaitTimeMinutes} 分钟</p>
                        `;
                        
                        // 更新进度条
                        const progressPercentage = Math.max(0, Math.min(100, 100 - (waitingTasks * 10)));
                        progressFill.style.width = `${progressPercentage}%`;
                        progressText.textContent = `排队中 (${progressPercentage}%)`;
                        progressText.style.color = '#2c3e50';
                    } else {
                        // 没有任务在排队
                        if (runningTasks > 0) {
                            taskCountElement.textContent = '有任务';
                            taskBadgeElement.style.display = 'none';
                            
                            // 更新队列状态信息
                            queueStatus.innerHTML = `
                                <p>当前有 ${runningTasks} 个任务正在处理</p>
                                <p>您的任务将在队列空闲后立即开始</p>
                            `;
                            
                            // 更新进度条
                            progressFill.style.width = '100%';
                            progressFill.style.backgroundColor = '#007bff'; // 蓝色表示准备中
                            progressText.textContent = '准备中';
                            progressText.style.color = 'white';
                        } else {
                            taskCountElement.textContent = '0';
                            taskBadgeElement.style.display = 'none';
                            
                            // 更新队列状态信息
                            queueStatus.innerHTML = `
                                <p>当前队列为空</p>
                                <p>您的任务将立即开始处理</p>
                            `;
                            
                            // 更新进度条
                            progressFill.style.width = '100%';
                            progressFill.style.backgroundColor = '#28a745'; // 绿色表示完成
                            progressText.textContent = '就绪';
                            progressText.style.color = 'white';
                        }
                    }
                } catch (error) {
                    console.error('获取任务队列状态失败:', error);
                    
                    // 显示错误信息
                    const queueStatusContainer = document.getElementById('queueStatusContainer');
                    const queueStatus = document.getElementById('queueStatus');
                    
                    queueStatusContainer.style.display = 'block';
                    queueStatus.innerHTML = `<p style="color: #dc3545;">无法获取队列状态，请刷新页面重试</p>`;
                }
            }
            
            // 打开任务模态框
            function openTaskModal() {
                // 显示模态框
                const modal = document.getElementById('taskModal');
                modal.style.display = 'block';
                
                // 添加关闭事件
                const closeSpan = modal.querySelector('.close');
                const closeButton = modal.querySelector('.close-button');
                
                if (closeSpan) {
                    closeSpan.onclick = function() {
                        modal.style.display = 'none';
                    };
                }
                
                if (closeButton) {
                    closeButton.onclick = function() {
                        modal.style.display = 'none';
                    };
                }
                
                // 点击模态框外部关闭
                window.onclick = function(event) {
                    if (event.target == modal) {
                        modal.style.display = 'none';
                    }
                };
                
                // 首次加载任务列表
                loadTaskList();
            }
            
            // 加载任务列表
            async function loadTaskList() {
                try {
                    const response = await fetch('/api/task_queue/all_tasks');
                    const tasks = await response.json();
                    
                    const taskListElement = document.getElementById('taskList');
                    taskListElement.innerHTML = '';
                    
                    if (tasks.length === 0) {
                        taskListElement.innerHTML = '<p class="no-tasks">暂无任务记录</p>';
                        return;
                    }
                    
                    tasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = 'task-item';
                        
                        // 格式化任务信息
                        const statusClass = getStatusClass(task.status);
                        const formattedTime = new Date(task.timestamp).toLocaleString('zh-CN');
                        let resultHtml = '';
                        
                        if (task.status === 'completed' && task.result) {
                            resultHtml = '<button class="view-result-btn" onclick="viewTaskResult(\'' + task.task_id + '\')">查看结果</button>';
                        }
                        
                        taskItem.innerHTML = `
                            <div class="task-header">
                                <span class="task-type">${task.task_type}</span>
                                <span class="status-badge ${statusClass}">${getStatusText(task.status)}</span>
                            </div>
                            <div class="task-info">
                                <p class="task-id">ID: ${task.task_id}</p>
                                <p class="task-time">时间: ${formattedTime}</p>
                                ${task.duration ? `<p class="task-duration">耗时: ${task.duration}秒</p>` : ''}
                            </div>
                            <div class="task-params">
                                ${formatTaskParams(task.params)}
                            </div>
                            <div class="task-actions">
                                ${resultHtml}
                            </div>
                        `;
                        
                        taskListElement.appendChild(taskItem);
                    });
                } catch (error) {
                    console.error('加载任务列表失败:', error);
                    document.getElementById('taskList').innerHTML = '<p class="error-message">加载任务列表失败</p>';
                }
            }
            
            // 辅助函数：获取状态样式类
            function getStatusClass(status) {
                const statusClasses = {
                    'queued': 'status-queued',
                    'processing': 'status-processing',
                    'completed': 'status-completed',
                    'error': 'status-error'
                };
                return statusClasses[status] || '';
            }
            
            // 辅助函数：获取状态文本
            function getStatusText(status) {
                const statusTexts = {
                    'queued': '排队中',
                    'processing': '处理中',
                    'completed': '已完成',
                    'error': '失败'
                };
                return statusTexts[status] || status;
            }
            
            // 辅助函数：格式化任务参数
            function formatTaskParams(params) {
                if (!params || typeof params !== 'object') {
                    return '';
                }
                
                let result = '<div class="params-list">';
                Object.entries(params).forEach(([key, value]) => {
                    // 避免显示敏感信息或过长内容
                    if (key.toLowerCase().includes('password') || key.toLowerCase().includes('token') || key.toLowerCase().includes('secret')) {
                        value = '****';
                    } else if (typeof value === 'string' && value.length > 50) {
                        value = value.substring(0, 50) + '...';
                    }
                    result += `<div class="param-item"><strong>${key}:</strong> ${value}</div>`;
                });
                result += '</div>';
                return result;
            }
            
            // 查看任务结果
            function viewTaskResult(taskId) {
                alert('查看任务 ' + taskId + ' 的结果');
                // 这里可以添加查看结果的具体逻辑
            }
            
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.querySelector('form');
                
                // 启动任务队列状态轮询
                startQueueStatusPolling();
                
                // 检查是否有排队消息
                const flashMessages = document.querySelectorAll('.status-box');
                let hasQueueMessage = false;
                
                flashMessages.forEach(message => {
                    if (message.textContent.includes('排队')) {
                        hasQueueMessage = true;
                    }
                });
                
                if (hasQueueMessage) {
                    // 显示队列状态容器
                    document.getElementById('queueStatusContainer').style.display = 'block';
                }
            });
            
            // 页面卸载时停止轮询
            window.addEventListener('beforeunload', function() {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
            });
        </script>
        
        <!-- 引入任务模态框 -->
        {% include 'task_modal.html' %}
    </body>
</html>