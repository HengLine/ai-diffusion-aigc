<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文生图 - AIGC创意平台</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            background-color: #f5f5f5;
        }
        header {
            background-color: #4a6fa5;
            color: white;
            padding: 1.5rem 0;
            text-align: center;
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        header h1 {
            margin: 0;
            font-size: 2rem;
        }
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            font-family: inherit;
            min-height: 120px;
            box-sizing: border-box;
            resize: vertical;
        }
        .form-group textarea:focus {
            outline: none;
            border-color: #4a6fa5;
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }
        .form-button {
            background-color: #4a6fa5;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .form-button:hover {
            background-color: #3a5a85;
        }
        .form-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .back-link {
            display: inline-block;
            margin-top: 1rem;
            color: #4a6fa5;
            text-decoration: none;
            font-weight: 500;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        
        /* 参数控制优化样式 */
        .parameter-group {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e9ecef;
        }
        
        .parameter-group h3 {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .parameter-group h3::after {
            content: '▼';
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }
        
        .parameter-group.collapsed h3::after {
            transform: rotate(-90deg);
        }
        
        .parameter-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .parameter-group.collapsed .parameter-content {
            max-height: 0;
        }
        
        .parameter-group h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* 滑块样式 */
        .slider-container {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .slider-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            outline: none;
            transition: background 0.3s ease;
        }
        
        .slider:hover {
            background: #ccc;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4a6fa5;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .slider::-webkit-slider-thumb:hover {
            background: #3a5a85;
            transform: scale(1.1);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4a6fa5;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }
        
        .slider::-moz-range-thumb:hover {
            background: #3a5a85;
            transform: scale(1.1);
        }
        
        .slider-value {
            min-width: 60px;
            padding: 0.5rem;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            color: #4a6fa5;
        }
        
        /* 数字输入框样式优化 */
        .number-input {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .number-input:focus {
            outline: none;
            border-color: #4a6fa5;
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }
        
        .parameter-description {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #6c757d;
            line-height: 1.4;
        }
        .status-box {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }
        .queue-status {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        .queue-status h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #495057;
            font-size: 1.1rem;
        }
        .queue-status p {
            margin: 5px 0;
            color: #6c757d;
        }
        .task-progress {
            margin-top: 15px;
        }
        .task-progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        .task-progress-fill {
            height: 100%;
            background-color: #4a6fa5;
            transition: width 0.3s ease;
        }
        .task-progress-text {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2c3e50;
            font-weight: 500;
        }
        .tips {
            background-color: #fff3cd;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #ffc107;
        }
        .tips h3 {
            margin-top: 0;
            color: #856404;
        }
        .tips ul {
            margin-bottom: 0;
            padding-left: 1.5rem;
        }
        .tips li {
            margin-bottom: 0.5rem;
        }
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- 引入公共组件 -->
    {% include 'components/header.html' %}
    {% include 'components/common_scripts.html' %}

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="status-box status-{{ category }}">
                        <p>{{ message }}</p>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="tips">
            <h3>提示词编写指南</h3>
            <ul>
                <li>描述要清晰具体，包含主体、环境、风格、细节等</li>
                <li>使用英文分号(;)分隔不同的描述元素</li>
                <li>可以指定艺术家风格、艺术流派等</li>
                <li>适当使用负面提示词排除不想要的效果</li>
            </ul>
        </div>

        <form method="post">
            <div class="form-group">
                <label for="prompt">提示词 (必填)</label>
                <textarea id="prompt" name="prompt" placeholder="请输入图像描述，例如：a beautiful landscape with mountains and lake, high detailed, 4k, realistic lighting">{{ default_params.prompt or '' }}</textarea>
            </div>
            
            <div class="form-group">
                <label for="negative_prompt">负面提示词</label>
                <textarea id="negative_prompt" name="negative_prompt" placeholder="请输入不想要的效果，例如：low quality, blurry, bad anatomy, extra limbs">{{ default_params.negative_prompt or 'low quality, blurry, bad anatomy, extra limbs, disfigured, worst quality, lowres, signature, watermark, username' }}</textarea>
            </div>
            
            <!-- 模型参数设置 -->
            <div class="parameter-group collapsed">
                <h3>模型参数设置</h3>
                <div class="parameter-content">
                <div class="slider-container">
                    <label for="steps">生成步数</label>
                    <div class="slider-input-group">
                        <input type="range" class="slider" id="stepsSlider" min="5" max="100" step="1" value="{{ default_params.steps or 30 }}">
                        <input type="number" class="slider-value" id="steps" name="steps" min="5" max="100" value="{{ default_params.steps or 30 }}">
                    </div>
                    <div class="parameter-description">
                        步数越多，细节越丰富，但生成时间越长，建议值：20-40
                    </div>
                </div>
                
                <div class="slider-container">
                    <label for="cfg">提示引导强度（CFG Scale）</label>
                    <div class="slider-input-group">
                        <input type="range" class="slider" id="cfgSlider" min="1" max="100" step="0.5" value="{{ default_params.cfg or 8.0 }}">
                        <input type="number" class="slider-value" id="cfg" name="cfg" min="1" max="100" step="0.5" value="{{ default_params.cfg or 8.0 }}">
                    </div>
                    <div class="parameter-description">
                        值越高，越严格遵循提示词，建议值：4.0-12.0
                    </div>
                    <div class="parameter-description">
                        <li>1-3：非常弱的提示引导，图像更“自由”，可能偏离提示，但风格更自然、有创意。实验性创作、抽象艺术、想获得意外效果时</li>
                        <li>4 ~ 7推荐范围（平衡点）：提示有明显影响，同时保留自然细节和多样性。大多数通用场景，如人物、风景、插画等</li>
                        <li>8 ~ 12：强烈遵循提示，细节更贴合文字，但可能出现过度锐化、不自然或伪影。需要精确控制构图、文字、物体位置的场景</li>
                        <li>13 ~ 20+：极强引导，极易产生“过拟合”：色彩怪异、结构扭曲、纹理重复、噪点增多。仅用于极端需求，如特定品牌Logo、复杂文字渲染（慎用）</li>
                    </div>
                </div>
                
                <div class="slider-container">
                    <label for="denoise">降噪强度（Denoise）</label>
                    <div class="slider-input-group">
                        <input type="range" class="slider" id="denoiseSlider" min="0" max="1" step="0.05" value="{{ default_params.denoise or 0.75 }}">
                        <input type="number" class="slider-value" id="denoise" name="denoise" min="0" max="1" step="0.05" value="{{ default_params.denoise or 0.75 }}">
                    </div>
                    <div class="parameter-description">
                        控制生成图像的随机性，值越低越接近初始状态，建议值：0.5-1.0
                    </div>
                    <div class="parameter-description">
                        <li>0-0.2：极低去噪，保留大部分初始特征，仅轻微优化细节。微调现有图像细节、修复轻微瑕疵时</li>
                        <li>0.3-0.5：中等去噪，保持基本结构，同时引入新变化。风格迁移、保持构图同时改变风格时</li>
                        <li>0.6-0.8推荐范围：平衡保留和创新，既有初始特征影响，又有足够的创作自由度。大多数创意生成场景</li>
                        <li>0.9-1.0：高去噪，几乎完全重新生成，仅保留最基本的语义信息。从零开始的创意生成，希望获得全新图像时</li>
                    </div>
                </div>
                </div>
            </div>
            
            <div class="parameter-group collapsed">
                <h3>图像生成设置</h3>
                <div class="parameter-content">
                <div class="slider-container">
                    <label for="width">图像宽度（像素）</label>
                    <div class="slider-input-group">
                        <input type="range" class="slider" id="widthSlider" min="256" max="1024" step="64" value="{{ default_params.width or 512 }}">
                        <input type="number" class="slider-value" id="width" name="width" min="256" max="1024" step="64" value="{{ default_params.width or 512 }}">
                    </div>
                    <div class="parameter-description">
                        生成图像的宽度，推荐值：512-1024
                    </div>
                </div>
                
                <div class="slider-container">
                    <label for="height">图像高度（像素）</label>
                    <div class="slider-input-group">
                        <input type="range" class="slider" id="heightSlider" min="256" max="1024" step="64" value="{{ default_params.height or 512 }}">
                        <input type="number" class="slider-value" id="height" name="height" min="256" max="1024" step="64" value="{{ default_params.height or 512 }}">
                    </div>
                    <div class="parameter-description">
                        生成图像的高度，推荐值：512-1024
                    </div>
                </div>
                
                <div class="slider-container">
                    <label for="batch_size">生成数量</label>
                    <div class="slider-input-group">
                        <input type="range" class="slider" id="numImagesSlider" min="1" max="10" step="1" value="{{ default_params.batch_size or 1 }}">
                        <input type="number" class="slider-value" id="batch_size" name="batch_size" min="1" max="10" step="1" value="{{ default_params.batch_size or 1 }}">
                    </div>
                    <div class="parameter-description">
                        一次生成的图像数量，最多10张，建议值：1-5
                    </div>
                </div>
                </div>
            </div>
            <button type="submit" class="form-button" id="generateButton">生成图像</button>
            <div id="loadingIndicator" style="display: none; margin-top: 10px; color: #4a6fa5;">
                <div style="display: flex; align-items: center;">
                    <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #4a6fa5; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span style="margin-left: 10px;">正在生成图像，请稍候...</span>
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const generateButton = document.getElementById('generateButton');
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    const form = document.querySelector('form');
                    
                    // 参数折叠/展开功能
            function setupParameterFolding() {
                const parameterGroups = document.querySelectorAll('.parameter-group');
                parameterGroups.forEach(group => {
                    const header = group.querySelector('h3');
                    header.addEventListener('click', () => {
                        group.classList.toggle('collapsed');
                    });
                });
            }
            
            // 同步滑块和输入框的值
            function setupSliderSync(sliderId, inputId) {
                        const slider = document.getElementById(sliderId);
                        const input = document.getElementById(inputId);
                        
                        if (slider && input) {
                            // 当滑块值变化时更新输入框
                            slider.addEventListener('input', function() {
                                input.value = this.value;
                            });
                            
                            // 当输入框值变化时更新滑块
                            input.addEventListener('input', function() {
                                // 确保值在有效范围内
                                const min = parseFloat(this.min);
                                const max = parseFloat(this.max);
                                const step = parseFloat(this.step);
                                let value = parseFloat(this.value);
                                
                                if (isNaN(value)) value = min;
                                if (value < min) value = min;
                                if (value > max) value = max;
                                
                                // 根据步长调整值
                                value = Math.round(value / step) * step;
                                
                                this.value = value;
                                slider.value = value;
                            });
                        }
                    }
                    
                    // 设置所有滑块的同步
            setupSliderSync('widthSlider', 'width');
            setupSliderSync('heightSlider', 'height');
            setupSliderSync('stepsSlider', 'steps');
            setupSliderSync('cfgSlider', 'cfg');
            setupSliderSync('denoiseSlider', 'denoise');
            setupSliderSync('numImagesSlider', 'batch_size');
            
            // 设置参数折叠功能
            setupParameterFolding();
                    
                    
                });
                
                // 添加加载动画样式
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
                
                // 页面加载完成后自动启动任务队列状态轮询
                if (typeof startQueueStatusPolling === 'function') {
                    startQueueStatusPolling();
                } else {
                    console.warn('startQueueStatusPolling function not available');
                }
            </script>
        </form>
        
        <!-- 任务队列状态显示区域 -->
        {% include 'components/task_queue_status.html' %}

        <a href="{{ url_for('index') }}" class="back-link">← 返回首页</a>
    </div>
    
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            // 移动端菜单功能已在header组件中定义
            
            // 任务队列相关函数已在task_queue_status.html组件中定义
            

            
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.querySelector('form');
                const generateButton = document.getElementById('generateButton');
                const loadingIndicator = document.getElementById('loadingIndicator');
                
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // 获取表单数据并转换为JSON格式
                    const prompt = document.getElementById('prompt').value;
                    const negativePrompt = document.getElementById('negative_prompt').value;
                    
                    // 验证提示词不能为空
                    if (!prompt.trim()) {
                        showNotification('请输入提示词！', 'warning', 3000);
                        return;
                    }
                    
                    // 获取新添加的参数
                    const width = document.getElementById('width').value;
                    const height = document.getElementById('height').value;
                    const steps = document.getElementById('steps').value;
                    const cfgScale = document.getElementById('cfg').value;
                    const numImages = document.getElementById('batch_size').value;
                    const denoise = document.getElementById('denoise').value;
                    
                    // 准备JSON数据 - 注意：文生图不需要strength参数
                    const jsonData = {
                        prompt: prompt,
                        negative_prompt: negativePrompt,
                        width: parseInt(width),
                        height: parseInt(height),
                        steps: parseInt(steps),
                        cfg: parseFloat(cfgScale),
                        batch_size: parseInt(numImages),
                        denoise: parseFloat(denoise)
                    };
                    
                    // 禁用按钮防止重复点击
                    generateButton.disabled = true;
                    generateButton.textContent = '生成中...';
                    // 显示加载指示器
                    loadingIndicator.style.display = 'block';
                    
                    try {
                        const response = await fetch('/api/text_to_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' // 正确设置Content-Type
                    },
                    body: JSON.stringify(jsonData) // 转换为JSON字符串
                });
                        
                        if (!response.ok) {
                            // 获取错误详情
                            const errorData = await response.json();
                            throw new Error(errorData.message || '请求失败');
                        }
                        
                        const data = await response.json();
                        
                        // 处理响应
                        if (data.success) {
                            // 显示自动关闭的成功提示
                            showAutoCloseNotification('任务提交成功，请在"我的任务"中查看进度', 2000);
                            // 刷新任务队列状态
                            updateQueueStatus();
                            generateButton.disabled = false;
                            generateButton.textContent = '生成图像';
                            loadingIndicator.style.display = 'none';
                        } else if (data.queued) {
                            // 显示队列状态容器
                            document.getElementById('queueStatusContainer').style.display = 'block';
                            // 显示排队信息
                            document.getElementById('queueStatus').innerHTML = `<p>${data.message}</p>`;
                            // 刷新任务队列状态
                            updateQueueStatus();
                            generateButton.disabled = false;
                            generateButton.textContent = '生成图像';
                            loadingIndicator.style.display = 'none';
                        }
                    } catch (error) {
                        showNotification(`请求失败: ${error.message}`, 'error', 3000);
                        // 恢复按钮状态
                        generateButton.disabled = false;
                        generateButton.textContent = '生成图像';
                        loadingIndicator.style.display = 'none';
                    }
                });
            });
            
            // 启动任务队列状态轮询
                if (typeof startQueueStatusPolling === 'function') {
                    startQueueStatusPolling();
                }

        </script>
        
        <!-- 引入公共组件 -->
        {% include 'components/notification.html' %}
        
        <!-- 引入任务队列状态组件 -->
        {% include 'components/task_queue_status.html' %}
        
        <!-- 引入任务模态框 -->
        {% include 'components/task_modal.html' %}
        
        <!-- 引入页脚组件 -->
        {% include 'components/footer.html' %}
    </body>
</html>