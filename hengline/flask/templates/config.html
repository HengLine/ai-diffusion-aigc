<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置管理 - AIGC创意平台</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            background-color: #f5f5f5;
        }
        header {
            background-color: #4a6fa5;
            color: white;
            padding: 1.5rem 0;
            text-align: center;
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        header h1 {
            margin: 0;
            font-size: 2rem;
        }
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            /* margin: 0 auto; */
            justify-content: center;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: #4a6fa5;
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }
        .form-button {
            background-color: #4a6fa5;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            margin: 0 auto;
            display: flex;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .form-button:hover {
            background-color: #3a5a85;
        }
        .back-link {
            display: inline-block;
            margin-top: 1rem;
            color: #4a6fa5;
            text-decoration: none;
            font-weight: 500;
        }
        .back-link:hover {
            text-decoration: underline;
        }
        .status-box {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        .info-box {
            background-color: #e3f2fd;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #1976d2;
        }
        .info-box h3 {
            margin-top: 0;
            color: #1976d2;
        }
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }
        }
        
        /* 参数标签样式 */
        .param-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 0.5rem;
        }
        
        .param-icon {
            background-color: #4a6fa5;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: help;
        }
        
        .param-content {
            visibility: hidden;
            width: 400px;
            background-color: #2c3e50;
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-line;
        }
        
        .param-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }
        
        .param-tooltip:hover .param-content {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- 引入公共组件 -->
    {% include 'components/header.html' %}
    {% include 'components/common_scripts.html' %}
    {% include 'components/workflow_modal.html' %}

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <script>
                    // 页面加载后显示flash消息为右下角通知
                    document.addEventListener('DOMContentLoaded', function() {
                        {% for category, message in messages %}
                            showAutoCloseNotification('{{ message | safe }}', '{{ category }}', 3000);
                        {% endfor %}
                    });
                </script>
            {% endif %}
        {% endwith %}

        <form method="post">
            <div class="info-box">
                <h3>ComfyUI配置</h3>
                <p>请输入您的ComfyUI API URL地址，这是使用AI生成功能的必要条件。</p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <div class="form-group">
                    <label for="comfyui_api_url">ComfyUI API URL <span style="color: red;">*</span></label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="text" id="comfyui_api_url" name="comfyui_api_url" 
                            value="{{ comfyui_api_url }}" placeholder="例如：http://127.0.0.1:8188" required style="flex: 1;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="comfyui_device">所在设备环境 <span style="color: red;">*</span></label>
                    <div style="display: flex; align-items: center; gap: 1rem; display: flex;">
                        <input style="width: 10%;" type="radio" name="comfyui_device" value="gpu" {% if comfyui_device == 'gpu' %}checked{% endif %}>GPU
                        <input style="width: 10%;"  type="radio" name="comfyui_device" value="cpu" {% if comfyui_device == 'cpu' %}checked{% endif %}>CPU
                        <span style="color: red; font-size: 0.8rem; font-style: italic;  width: 80%; font-weight: 400; line-height: 1.2; margin-bottom: 0.5rem;">
                            （对于5秒的视频，CPU比GPU慢大约 50-200 倍）</span>
                    </div>
                </div>
            </div>
            
            <div class="info-box" style="margin-top: 2rem;">
                <h3>用户信息</h3>
                <p>请输入您的用户信息，包括邮箱和昵称（当任务执行异常时，会通过该邮箱通知您）。</p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                
                <div class="form-group">
                    <label for="nickname">昵称 <span style="color: red;">*</span></label>
                    <input type="text" id="nickname" name="nickname" 
                           value="{{ user_nickname }}" placeholder="请输入您的用户昵称" required>
                </div>
                <div class="form-group">
                    <label for="email">电子邮箱 <span style="color: red;">*</span></label>
                    <input type="email" id="email" name="email" 
                           value="{{ user_email }}" placeholder="请输入您的电子邮箱" required>
                </div>
                
            </div>
            
            <div class="info-box" style="margin-top: 2rem;">
                <h3>模型参数配置</h3>
                <p>请选择不同类型，配置对应的模型参数默认值（生成过程中默认会使用这些参数，也可以在生成界面独立修改）。</p>
            </div>
            
            <!-- Tab 切换按钮 -->
            <div class="tab-buttons" style="margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <button type="button" class="tab-btn" onclick="openTab(event, 'textToImage')" style="background-color: #4a6fa5; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">文生图</button>
                <button type="button" class="tab-btn" onclick="openTab(event, 'imageToImage')" style="background-color: #ccc; color: #333; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">图生图</button>
                <button type="button" class="tab-btn" onclick="openTab(event, 'textToVideo')" style="background-color: #ccc; color: #333; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">文生视频</button>
                <button type="button" class="tab-btn" onclick="openTab(event, 'imageToVideo')" style="background-color: #ccc; color: #333; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">图生视频</button>
                <button type="button" class="tab-btn" onclick="openTab(event, 'textToAudio')" style="background-color: #ccc; color: #333; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">文生音频</button>
            </div>
            
            <!-- 文生图 Tab 内容 -->
            <div id="textToImage" class="tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin-top: 0; margin-bottom: 0;">文生图参数</h3>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" id="customWorkflowTextToImage" class="form-button" style="background-color: #28a745; margin: 0;" onclick="openWorkflowModal('text_to_image')">自定义工作流</button>
                        <button type="button" id="resetTextToImage" class="form-button" style="background-color: #f39c12; margin: 0;">恢复初始值</button>
                    </div>
                </div>
                
                <div class="grid-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="form-group">
                        <label for="tti_width">生成图片宽度 <span style="color: red;">*</span></label>
                        <input type="number" id="tti_width" name="settings[text_to_image][width]" 
                               value="{{ settings.text_to_image.width }}" min="256" max="2048" step="64">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成图片的水平像素数，建议值: 1024</small>
                    </div>
                    <div class="form-group">
                        <label for="tti_height">生成图片高度 <span style="color: red;">*</span></label>
                        <input type="number" id="tti_height" name="settings[text_to_image][height]" 
                               value="{{ settings.text_to_image.height }}" min="256" max="2048" step="64">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成图片的垂直像素数，建议值: 1024</small>
                    </div>
                    <div class="form-group">
                        <label for="tti_steps">步数 <span style="color: red;">*</span></label>
                        <input type="number" id="tti_steps" name="settings[text_to_image][steps]" 
                               value="{{ settings.text_to_image.steps }}" min="1" max="100">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成过程中的迭代次数，值越高质量越好但速度越慢，建议值: 30-50</small>
                    </div>
                    <div class="form-group">
                        <label for="tti_cfg">提示引导强度（CFG Scale） <span style="color: red;">*</span></label>
                        <input type="number" id="tti_cfg" name="settings[text_to_image][cfg]"
                               value="{{ settings.text_to_image.cfg }}" min="1" max="30" step="0.01">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">控制生成结果与提示词的匹配程度，值越高越严格，建议值: 7.5-10</small>
                    </div>
                    <div class="form-group">
                        <label for="tti_sampler">采样算法 <span style="color: red;">*</span></label>
                        <select id="tti_sampler" name="settings[text_to_image][sampler_name]" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                            <option value="euler" {% if settings.text_to_image.sampler_name == 'euler' %}selected{% endif %}>⚡ Euler (快速基础)</option>
                            <option value="dpmpp_2m" {% if settings.text_to_image.sampler_name == 'dpmpp_2m' %}selected{% endif %}>⚖️ DPM++ 2M (平衡)</option>
                            <option value="dpmpp_3m_sde" {% if settings.text_to_image.sampler_name == 'dpmpp_3m_sde' %}selected{% endif %}>🔍 DPM++ 3M SDE (精细细节)</option>
                            <option value="dpmpp_3m_sde_gpu" {% if settings.text_to_image.sampler_name == 'dpmpp_3m_sde_gpu' %}selected{% endif %}>🚀 DPM++ 3M SDE GPU (GPU加速)</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 0.25rem;">选择生成图像的采样算法，不同算法在速度和质量上有不同表现</small>
                    </div>
                    <div class="form-group">
                        <label for="tti_batch_size">批量大小</label>
                        <input type="number" id="tti_batch_size" name="settings[text_to_image][batch_size]" 
                               value="{{ settings.text_to_image.batch_size }}" min="1" max="20">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">一次生成的图片数量，值越高消耗资源越多，建议值: 5-10</small>
                    </div>
                    <div class="form-group">
                        <label for="tti_seed">随机种子 (-1表示随机)</label>
                        <input type="number" id="tti_seed" name="settings[text_to_image][seed]" 
                               value="{{ settings.text_to_image.seed }}" min="-1">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">控制生成过程的随机性，使用相同种子可复现相同结果，建议值: -1 (随机)</small>
                    </div>
                    <div class="form-group">
                        <label for="tti_denoise">降噪强度</label>
                        <input type="number" id="tti_denoise" name="settings[text_to_image][denoise]" 
                               value="{{ settings.text_to_image.denoise }}" min="0" max="1" step="0.05">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">控制生成图像的随机性，值越低越接近初始状态，建议值: 0.5-0.7</small>
                    </div>

                </div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label for="tti_prompt">默认提示词</label>
                    <textarea id="tti_prompt" name="settings[text_to_image][prompt]" 
                              rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; box-sizing: border-box;">{{ settings.text_to_image.prompt }}</textarea>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">生成图片时使用的默认描述文本，可以在生成界面修改</small>
                </div>
                
                <div class="form-group">
                    <label for="tti_negative_prompt">默认负面提示词</label>
                    <textarea id="tti_negative_prompt" name="settings[text_to_image][negative_prompt]" 
                              rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; box-sizing: border-box;">{{ settings.text_to_image.negative_prompt }}</textarea>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">用于避免生成不想要的内容，如: low quality, blurry, pixelated</small>
                </div>
            </div>
            
            <!-- 文生音频 Tab 内容 -->
            <div id="textToAudio" class="tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin-top: 0; margin-bottom: 0;">文生音频参数</h3>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" id="customWorkflowTextToAudio" class="form-button" style="background-color: #28a745; margin: 0;" onclick="openWorkflowModal('text_to_audio')">自定义工作流</button>
                        <button type="button" id="resetTextToAudio" class="form-button" style="background-color: #f39c12; margin: 0;">恢复初始值</button>
                    </div>
                </div>
                
                <div class="grid-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="form-group">
                        <label for="tta_steps">生成步数 <span style="color: red;">*</span></label>
                        <input type="number" id="tta_steps" name="settings[text_to_audio][steps]" 
                               value="{{ settings.text_to_audio.steps }}" min="5" max="100">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成过程中的迭代次数，值越高质量越好但速度越慢，建议值: 30-50</small>
                    </div>
                    <div class="form-group">
                        <label for="tta_cfg">提示引导强度（CFG Scale） <span style="color: red;">*</span></label>
                        <input type="number" id="tta_cfg" name="settings[text_to_audio][cfg]"
                               value="{{ settings.text_to_audio.cfg }}" min="1" max="30" step="0.01">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">控制生成结果与提示词的匹配程度，值越高越严格，建议值: 5.0-7.0</small>
                    </div>
                    <div class="form-group">
                        <label for="tta_sampler">采样算法 <span style="color: red;">*</span></label>
                        <select id="tta_sampler" name="settings[text_to_audio][sampler_name]" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                            <option value="euler" {% if settings.text_to_audio.sampler_name == 'euler' %}selected{% endif %}>⚡ Euler (快速基础)</option>
                            <option value="dpmpp_2m" {% if settings.text_to_audio.sampler_name == 'dpmpp_2m' %}selected{% endif %}>⚖️ DPM++ 2M (平衡)</option>
                            <option value="dpmpp_3m_sde" {% if settings.text_to_audio.sampler_name == 'dpmpp_3m_sde' %}selected{% endif %}>🔍 DPM++ 3M SDE (精细细节)</option>
                            <option value="dpmpp_3m_sde_gpu" {% if settings.text_to_audio.sampler_name == 'dpmpp_3m_sde_gpu' %}selected{% endif %}>🚀 DPM++ 3M SDE GPU (GPU加速)</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 0.25rem;">选择生成音频的采样算法，不同算法在速度和质量上有不同表现</small>
                    </div>
                    <div class="form-group">
                        <label for="tta_seconds">音频时长（秒） <span style="color: red;">*</span></label>
                        <input type="number" id="tta_seconds" name="settings[text_to_audio][seconds]" 
                               value="{{ settings.text_to_audio.seconds }}" min="5" max="60" step="1">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">音频时长，建议值：10-30秒</small>
                    </div>
                    <div class="form-group">
                        <label for="tta_batch_size">生成数量</label>
                        <input type="number" id="tta_batch_size" name="settings[text_to_audio][batch_size]" 
                               value="{{ settings.text_to_audio.batch_size }}" min="1" max="5" step="1">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成的音频数量，最多5个，建议值：1</small>
                    </div>
                    <div class="form-group">
                        <label for="tta_seed">随机种子 (-1表示随机)</label>
                        <input type="number" id="tta_seed" name="settings[text_to_audio][seed]" 
                               value="{{ settings.text_to_audio.seed }}" min="-1">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">控制生成过程的随机性，使用相同种子可复现相同结果，建议值: -1 (随机)</small>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label for="tta_prompt">默认提示词</label>
                    <textarea id="tta_prompt" name="settings[text_to_audio][prompt]" 
                              rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; box-sizing: border-box;">{{ settings.text_to_audio.prompt }}</textarea>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">生成音频时使用的默认描述文本，可以在生成界面修改</small>
                </div>
                
                <div class="form-group">
                    <label for="tta_negative_prompt">默认负面提示词</label>
                    <textarea id="tta_negative_prompt" name="settings[text_to_audio][negative_prompt]" 
                              rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; box-sizing: border-box;">{{ settings.text_to_audio.negative_prompt }}</textarea>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">用于避免生成不想要的内容，如: low quality, noisy, distorted</small>
                </div>
            </div>
            
            <!-- 图生图 Tab 内容 -->
            <div id="imageToImage" class="tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin-top: 0; margin-bottom: 0;">图生图参数</h3>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" id="customWorkflowImageToImage" class="form-button" style="background-color: #28a745; margin: 0;" onclick="openWorkflowModal('image_to_image')">自定义工作流</button>
                        <button type="button" id="resetImageToImage" class="form-button" style="background-color: #f39c12; margin: 0;">恢复初始值</button>
                    </div>
                </div>
                
                <div class="grid-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="form-group">
                        <label for="iti_width">生成图片宽度 <span style="color: red;">*</span></label>
                        <input type="number" id="iti_width" name="settings[image_to_image][width]" 
                               value="{{ settings.image_to_image.width }}" min="256" max="2048" step="64">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成图片的水平像素数，建议值: 1024</small>
                    </div>
                    <div class="form-group">
                        <label for="iti_height">生成图片高度 <span style="color: red;">*</span></label>
                        <input type="number" id="iti_height" name="settings[image_to_image][height]" 
                               value="{{ settings.image_to_image.height }}" min="256" max="2048" step="64">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成图片的垂直像素数，建议值: 1024</small>
                    </div>
                    <div class="form-group">
                        <label for="iti_steps">步数 <span style="color: red;">*</span></label>
                        <input type="number" id="iti_steps" name="settings[image_to_image][steps]" 
                               value="{{ settings.image_to_image.steps }}" min="1" max="100">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成过程中的迭代次数，值越高质量越好但速度越慢，建议值: 30-50</small>
                    </div>
                    <div class="form-group">
                        <label for="iti_cfg">提示引导强度（CFG Scale） <span style="color: red;">*</span></label>
                        <input type="number" id="iti_cfg" name="settings[image_to_image][cfg]"
                               value="{{ settings.image_to_image.cfg }}" min="1" max="30" step="0.01">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">控制生成结果与提示词的匹配程度，值越高越严格，建议值: 7.5-10</small>
                    </div>
                    <div class="form-group">
                        <label for="iti_sampler">采样算法 <span style="color: red;">*</span></label>
                        <select id="iti_sampler" name="settings[image_to_image][sampler_name]" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                            <option value="euler" {% if settings.image_to_image.sampler_name == 'euler' %}selected{% endif %}>⚡ Euler (快速基础)</option>
                            <option value="dpmpp_2m" {% if settings.image_to_image.sampler_name == 'dpmpp_2m' %}selected{% endif %}>⚖️ DPM++ 2M (平衡)</option>
                            <option value="dpmpp_3m_sde" {% if settings.image_to_image.sampler_name == 'dpmpp_3m_sde' %}selected{% endif %}>🔍 DPM++ 3M SDE (精细细节)</option>
                            <option value="dpmpp_3m_sde_gpu" {% if settings.image_to_image.sampler_name == 'dpmpp_3m_sde_gpu' %}selected{% endif %}>🚀 DPM++ 3M SDE GPU (GPU加速)</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 0.25rem;">选择生成图像的采样算法，不同算法在速度和质量上有不同表现</small>
                    </div>
                    <div class="form-group">
                        <label for="iti_batch_size">批量大小</label>
                        <input type="number" id="iti_batch_size" name="settings[image_to_image][batch_size]" 
                               value="{{ settings.image_to_image.batch_size }}" min="1" max="20">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">一次生成的图片数量，值越高消耗资源越多，建议值: 5-10</small>
                    </div>
                    <div class="form-group">
                        <label for="iti_seed">随机种子 (-1表示随机)</label>
                        <input type="number" id="iti_seed" name="settings[image_to_image][seed]" 
                               value="{{ settings.image_to_image.seed }}" min="-1">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">控制生成过程的随机性，使用相同种子可复现相同结果，建议值: -1 (随机)</small>
                    </div>
                    <div class="form-group">
                        <label for="iti_denoise">降噪强度</label>
                        <input type="number" id="iti_denoise" name="settings[image_to_image][denoise]" 
                               value="{{ settings.image_to_image.denoise }}" min="0" max="1" step="0.05">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">控制原图保留程度，值越低越接近原图，建议值: 0.5-0.7</small>
                    </div>

                </div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label for="iti_prompt">默认提示词</label>
                    <textarea id="iti_prompt" name="settings[image_to_image][prompt]" 
                              rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; box-sizing: border-box;">{{ settings.image_to_image.prompt }}</textarea>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">生成图片时使用的默认描述文本，可以在生成界面修改</small>
                </div>
                
                <div class="form-group">
                    <label for="iti_negative_prompt">默认负面提示词</label>
                    <textarea id="iti_negative_prompt" name="settings[image_to_image][negative_prompt]" 
                              rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; box-sizing: border-box;">{{ settings.image_to_image.negative_prompt }}</textarea>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">用于避免生成不想要的内容，如: low quality, blurry, pixelated</small>
                </div>
            </div>
            
            <!-- 文生视频 Tab 内容 -->
            <div id="textToVideo" class="tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin-top: 0; margin-bottom: 0;">文生视频参数</h3>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" id="customWorkflowTextToVideo" class="form-button" style="background-color: #28a745; margin: 0;" onclick="openWorkflowModal('text_to_video')">自定义工作流</button>
                        <button type="button" id="resetTextToVideo" class="form-button" style="background-color: #f39c12; margin: 0;">恢复初始值</button>
                    </div>
                </div>
                
                <div class="grid-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="form-group">
                        <label for="ttv_width">生成视频宽度 <span style="color: red;">*</span></label>
                        <input type="number" id="ttv_width" name="settings[text_to_video][width]" 
                               value="{{ settings.text_to_video.width }}" min="256" max="1024" step="64">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成视频的水平像素数，建议值: 768</small>
                    </div>
                    <div class="form-group">
                        <label for="ttv_height">生成视频高度 <span style="color: red;">*</span></label>
                        <input type="number" id="ttv_height" name="settings[text_to_video][height]" 
                               value="{{ settings.text_to_video.height }}" min="256" max="1024" step="64">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成视频的垂直像素数，建议值: 576</small>
                    </div>
                    <div class="form-group">
                        <label for="ttv_length">生成视频长度（秒） <span style="color: red;">*</span></label>
                        <input type="number" id="ttv_length" name="settings[text_to_video][length]"
                               value="{{ settings.text_to_video.length }}" min="2" max="30" step="1">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成视频总时长，值越高速度越慢，建议值: 5-10</small>
                    </div>
                    <div class="form-group">
                        <label for="ttv_steps">步数 <span style="color: red;">*</span></label>
                        <input type="number" id="ttv_steps" name="settings[text_to_video][steps]" 
                               value="{{ settings.text_to_video.steps }}" min="1" max="100">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成过程中的迭代次数，值越高质量越好但速度越慢，建议值: 30-50</small>
                    </div>
                     <div class="form-group">
                        <label for="ttv_cfg">提示引导强度（CFG Scale） <span style="color: red;">*</span></label>
                        <input type="number" id="ttv_cfg" name="settings[text_to_video][cfg]"
                               value="{{ settings.text_to_video.cfg }}" min="1" max="30" step="0.01">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">控制生成结果与提示词的匹配程度，值越高越严格，建议值: 7.5-10</small>
                    </div>
                    <div class="form-group">
                        <label for="ttv_sampler">采样算法 <span style="color: red;">*</span></label>
                        <select id="ttv_sampler" name="settings[text_to_video][sampler_name]" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                            <option value="euler" {% if settings.text_to_video.sampler_name == 'euler' %}selected{% endif %}>⚡ Euler (快速基础)</option>
                            <option value="dpmpp_2m" {% if settings.text_to_video.sampler_name == 'dpmpp_2m' %}selected{% endif %}>⚖️ DPM++ 2M (平衡)</option>
                            <option value="dpmpp_3m_sde" {% if settings.text_to_video.sampler_name == 'dpmpp_3m_sde' %}selected{% endif %}>🔍 DPM++ 3M SDE (精细细节)</option>
                            <option value="dpmpp_3m_sde_gpu" {% if settings.text_to_video.sampler_name == 'dpmpp_3m_sde_gpu' %}selected{% endif %}>🚀 DPM++ 3M SDE GPU (GPU加速)</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 0.25rem;">选择生成视频的采样算法，不同算法在速度和质量上有不同表现</small>
                    </div>
                    <div class="form-group">
                        <label for="fps">帧率 <span style="color: red;">*</span></label>
                        <input type="number" id="fps" name="settings[text_to_video][fps]"
                               value="{{ settings.text_to_video.fps }}" min="4" max="64" step="2">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">每秒显示的帧数，值越高视频越流畅速度越慢，建议值: 16</small>
                    </div>
                    {#<div class="form-group">
                        <label for="ttv_shift">帧移</label>
                        <input type="number" id="ttv_shift" name="settings[text_to_video][shift]" 
                               value="{{ settings.text_to_video.shift }}" min="1" max="32">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">视频生成过程中的帧移参数，影响视频流畅度，建议值: 8</small>
                    </div>#}
                    <div class="form-group">
                        <label for="ttv_batch_size">批次大小</label>
                        <input type="number" id="ttv_batch_size" name="settings[text_to_video][batch_size]" 
                               value="{{ settings.text_to_video.batch_size }}" min="1" max="10">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">每次生成的视频数量，建议值: 1</small>
                    </div>
                    <div class="form-group">
                        <label for="ttv_denoise">降噪强度</label>
                        <input type="number" id="ttv_denoise" name="settings[text_to_video][denoise]" 
                               value="{{ settings.text_to_video.denoise }}" min="0" max="1" step="0.01">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成过程中的降噪强度，影响视频清晰度，建议值: 0.55</small>
                    </div>
                    <div class="form-group">
                        <label for="ttv_seed">随机种子 (-1表示随机)</label>
                        <input type="number" id="ttv_seed" name="settings[text_to_video][seed]" 
                               value="{{ settings.text_to_video.seed }}" min="-1">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">控制生成过程的随机性，使用相同种子可复现相同结果，建议值: -1 (随机)</small>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label for="ttv_prompt">默认提示词</label>
                    <textarea id="ttv_prompt" name="settings[text_to_video][prompt]" 
                              rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; box-sizing: border-box;">{{ settings.text_to_video.prompt }}</textarea>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">生成视频时使用的默认描述文本，可以在生成界面修改</small>
                </div>
                
                <div class="form-group">
                    <label for="ttv_negative_prompt">默认负面提示词</label>
                    <textarea id="ttv_negative_prompt" name="settings[text_to_video][negative_prompt]" 
                              rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; box-sizing: border-box;">{{ settings.text_to_video.negative_prompt }}</textarea>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">用于避免生成不想要的内容，如: low quality, blurry, pixelated</small>
                </div>
            </div>
            
            <!-- 图生视频 Tab 内容 -->
            <div id="imageToVideo" class="tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin-top: 0; margin-bottom: 0;">图生视频参数</h3>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" id="customWorkflowImageToVideo" class="form-button" style="background-color: #28a745; margin: 0;" onclick="openWorkflowModal('image_to_video')">自定义工作流</button>
                        <button type="button" id="resetImageToVideo" class="form-button" style="background-color: #f39c12; margin: 0;">恢复初始值</button>
                    </div>
                </div>
                
                <div class="grid-form" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="form-group">
                        <label for="itv_width">生成视频宽度 <span style="color: red;">*</span></label>
                        <input type="number" id="itv_width" name="settings[image_to_video][width]" 
                               value="{{ settings.image_to_video.width }}" min="256" max="1024" step="64">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成视频的水平像素数，建议值: 768</small>
                    </div>
                    <div class="form-group">
                        <label for="itv_height">生成视频高度 <span style="color: red;">*</span></label>
                        <input type="number" id="itv_height" name="settings[image_to_video][height]" 
                               value="{{ settings.image_to_video.height }}" min="256" max="1024" step="64">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成视频的垂直像素数，建议值: 576</small>
                    </div>
                    <div class="form-group">
                        <label for="itv_length">生成视频长度（秒） <span style="color: red;">*</span></label>
                        <input type="number" id="itv_length" name="settings[image_to_video][length]"
                               value="{{ settings.image_to_video.length }}" min="2" max="30">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成视频总时长，值越高速度越慢，建议值: 5-10</small>
                    </div>
                    <div class="form-group">
                        <label for="itv_steps">步数 <span style="color: red;">*</span></label>
                        <input type="number" id="itv_steps" name="settings[image_to_video][steps]" 
                               value="{{ settings.image_to_video.steps }}" min="1" max="100">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成过程中的迭代次数，值越高质量越好但速度越慢，建议值: 30-50</small>
                    </div>
                    <div class="form-group">
                        <label for="itv_cfg">提示引导强度（CFG Scale） <span style="color: red;">*</span></label>
                        <input type="number" id="itv_cfg" name="settings[image_to_video][cfg]"
                               value="{{ settings.image_to_video.cfg }}" min="1" max="30" step="0.01">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">控制生成结果与提示词的匹配程度，值越高越严格，建议值: 7.5-10</small>
                    </div>
                    <div class="form-group">
                        <label for="itv_sampler">采样算法 <span style="color: red;">*</span></label>
                        <select id="itv_sampler" name="settings[image_to_video][sampler_name]" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                            <option value="euler" {% if settings.image_to_video.sampler_name == 'euler' %}selected{% endif %}>⚡ Euler (快速基础)</option>
                            <option value="dpmpp_2m" {% if settings.image_to_video.sampler_name == 'dpmpp_2m' %}selected{% endif %}>⚖️ DPM++ 2M (平衡)</option>
                            <option value="dpmpp_3m_sde" {% if settings.image_to_video.sampler_name == 'dpmpp_3m_sde' %}selected{% endif %}>🔍 DPM++ 3M SDE (精细细节)</option>
                            <option value="dpmpp_3m_sde_gpu" {% if settings.image_to_video.sampler_name == 'dpmpp_3m_sde_gpu' %}selected{% endif %}>🚀 DPM++ 3M SDE GPU (GPU加速)</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 0.25rem;">选择生成视频的采样算法，不同算法在速度和质量上有不同表现</small>
                    </div>
                    <div class="form-group">
                        <label for="fps">帧率 <span style="color: red;">*</span></label>
                        <input type="number" id="fps" name="settings[image_to_video][fps]"
                               value="{{ settings.image_to_video.fps }}" min="4" max="64" step="2">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">每秒显示的帧数，值越高视频越流畅，建议值: 16</small>
                    </div>
                    {#<div class="form-group">
                        <label for="itv_shift">帧移</label>
                        <input type="number" id="itv_shift" name="settings[image_to_video][shift]" 
                               value="{{ settings.image_to_video.shift }}" min="1" max="32">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">视频生成过程中的帧移参数，影响视频流畅度，建议值: 8</small>
                    </div>#}
                    <div class="form-group">
                        <label for="itv_batch_size">批次大小</label>
                        <input type="number" id="itv_batch_size" name="settings[image_to_video][batch_size]" 
                               value="{{ settings.image_to_video.batch_size }}" min="1" max="10">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">每次生成的视频数量，建议值: 1</small>
                    </div>
                    <div class="form-group">
                        <label for="itv_denoise">降噪强度</label>
                        <input type="number" id="itv_denoise" name="settings[image_to_video][denoise]" 
                               value="{{ settings.image_to_video.denoise }}" min="0" max="1" step="0.01">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">生成过程中的降噪强度，影响视频清晰度，建议值: 0.6</small>
                    </div>
                    <div class="form-group">
                        <label for="itv_seed">随机种子 (-1表示随机)</label>
                        <input type="number" id="itv_seed" name="settings[image_to_video][seed]" 
                               value="{{ settings.image_to_video.seed }}" min="-1">
                        <small style="color: #666; display: block; margin-top: 0.25rem;">控制生成过程的随机性，使用相同种子可复现相同结果，建议值: -1 (随机)</small>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label for="itv_prompt">默认提示词</label>
                    <textarea id="itv_prompt" name="settings[image_to_video][prompt]" 
                              rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; box-sizing: border-box;">{{ settings.image_to_video.prompt }}</textarea>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">生成视频时使用的默认描述文本，可以在生成界面修改</small>
                </div>
                
                <div class="form-group">
                    <label for="itv_negative_prompt">默认负面提示词</label>
                    <textarea id="itv_negative_prompt" name="settings[image_to_video][negative_prompt]" 
                              rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; box-sizing: border-box;">{{ settings.image_to_video.negative_prompt }}</textarea>
                    <small style="color: #666; display: block; margin-top: 0.25rem;">用于避免生成不想要的内容，如: low quality, blurry, pixelated</small>
                </div>
            </div>
            
            <button type="submit" class="form-button" style="margin-top: 2rem;">保存配置</button>
        </form>

        <a href="{{ url_for('index') }}" class="back-link">← 返回首页</a>
    </div>

    <script>
        // 自定义确认对话框函数 - 美化样式，确定按钮居中显示
        function showConfirmDialog(message) {
            return new Promise((resolve) => {
                // 检查对话框容器是否存在，不存在则创建
                let dialogContainer = document.getElementById('customConfirmDialog');
                if (dialogContainer) {
                    document.body.removeChild(dialogContainer);
                }
                
                // 创建对话框容器
                dialogContainer = document.createElement('div');
                dialogContainer.id = 'customConfirmDialog';
                dialogContainer.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 2000;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                `;
                
                // 创建对话框主体
                const dialogBox = document.createElement('div');
                dialogBox.style.cssText = `
                    background-color: white;
                    border-radius: 12px;
                    padding: 30px;
                    width: 90%;
                    max-width: 400px;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    text-align: center;
                `;
                
                // 分析消息文本，提取主消息和警告信息
                let mainMessage = message;
                let hasWarning = false;
                
                // 检查消息是否包含警告文本
                if (message.includes('当前设置将会丢失。')) {
                    // 提取主消息（去除警告部分）
                    mainMessage = message.replace('当前设置将会丢失。', '').trim();
                    hasWarning = true;
                }
                
                // 创建消息文本
                const messageElement = document.createElement('p');
                messageElement.style.cssText = `
                    margin-bottom: 10px;
                    font-size: 16px;
                    color: #333;
                    line-height: 1.6;
                `;
                messageElement.textContent = mainMessage;
                
                // 创建警告文本（如果存在）
                let warningElement;
                if (hasWarning) {
                    warningElement = document.createElement('p');
                    warningElement.style.cssText = `
                        margin-bottom: 25px;
                        font-size: 14px;
                        color: #e67700;
                        font-weight: 500;
                    `;
                    warningElement.textContent = '当前设置将会丢失。';
                }
                
                // 创建按钮容器（确保按钮居中并显示在一行）
                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    justify-content: center;
                    gap: 15px;
                `;
                
                // 创建确认按钮
                const confirmButton = document.createElement('button');
                confirmButton.textContent = '确定';
                confirmButton.style.cssText = `
                    background-color: #4a6fa5;
                    color: white;
                    border: none;
                    padding: 12px 36px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    min-width: 120px;
                `;
                
                // 确认按钮悬停效果
                confirmButton.addEventListener('mouseover', function() {
                    this.style.backgroundColor = '#3a5a85';
                    this.style.transform = 'translateY(-2px)';
                });
                
                confirmButton.addEventListener('mouseout', function() {
                    this.style.backgroundColor = '#4a6fa5';
                    this.style.transform = 'translateY(0)';
                });
                
                // 确认按钮点击事件
                confirmButton.addEventListener('click', function() {
                    document.body.removeChild(dialogContainer);
                    resolve(true);
                });
                
                // 创建取消按钮
                const cancelButton = document.createElement('button');
                cancelButton.textContent = '取消';
                cancelButton.style.cssText = `
                    background-color: #f5f5f5;
                    color: #666;
                    border: 1px solid #ddd;
                    padding: 10px 32px;
                    border-radius: 8px;
                    font-size: 15px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    min-width: 100px;
                `;
                
                // 取消按钮悬停效果
                cancelButton.addEventListener('mouseover', function() {
                    this.style.backgroundColor = '#e9e9e9';
                });
                
                cancelButton.addEventListener('mouseout', function() {
                    this.style.backgroundColor = '#f5f5f5';
                });
                
                // 取消按钮点击事件
                cancelButton.addEventListener('click', function() {
                    document.body.removeChild(dialogContainer);
                    resolve(false);
                });
                
                // 组装对话框
                buttonContainer.appendChild(confirmButton);
                buttonContainer.appendChild(cancelButton);
                dialogBox.appendChild(messageElement);
                
                // 如果有警告文本，添加到对话框
                if (hasWarning && warningElement) {
                    dialogBox.appendChild(warningElement);
                }
                
                dialogBox.appendChild(buttonContainer);
                dialogContainer.appendChild(dialogBox);
                
                // 添加到页面
                document.body.appendChild(dialogContainer);
                
                // 添加动画效果
                setTimeout(() => {
                    dialogBox.style.opacity = '1';
                }, 10);
                
                // 按ESC键关闭对话框
                function handleEscKey(event) {
                    if (event.key === 'Escape') {
                        document.body.removeChild(dialogContainer);
                        resolve(false);
                        document.removeEventListener('keydown', handleEscKey);
                    }
                }
                
                document.addEventListener('keydown', handleEscKey);
            });
        }
        
        // 恢复初始值功能 - 使用AJAX请求避免页面刷新
        document.getElementById('resetTextToImage').addEventListener('click', async function() {
            const confirmed = await showConfirmDialog('确定要恢复到【文生图】参数的初始值吗？当前设置将会丢失。');
            if (confirmed) {
                // 显示加载状态
                showLoading(true);
                
                try {
                    const response = await fetch('/config/reset/text_to_image', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (response.ok) {
                        // 刷新当前页面但保持在原位
                        location.reload(false);
                    } else {
                        showAutoCloseNotification('恢复初始值失败，请重试！', 'error');
                    }
                } catch (error) {
                    console.error('恢复初始值时发生错误:', error);
                    showAutoCloseNotification('恢复初始值时发生网络错误，请重试！', 'error');
                } finally {
                    // 隐藏加载状态
                    showLoading(false);
                }
            }
        });
        
        document.getElementById('resetImageToImage').addEventListener('click', async function() {
            const confirmed = await showConfirmDialog('确定要恢复到【图生图】参数的初始值吗？当前设置将会丢失。');
            if (confirmed) {
                // 显示加载状态
                showLoading(true);
                
                try {
                    const response = await fetch('/config/reset/image_to_image', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (response.ok) {
                        // 刷新当前页面但保持在原位
                        location.reload(false);
                    } else {
                        showAutoCloseNotification('恢复初始值失败，请重试！', 'error');
                    }
                } catch (error) {
                    console.error('恢复初始值时发生错误:', error);
                    showAutoCloseNotification('恢复初始值时发生网络错误，请重试！', 'error');
                } finally {
                    // 隐藏加载状态
                    showLoading(false);
                }
            }
        });
        
        document.getElementById('resetTextToVideo').addEventListener('click', async function() {
            const confirmed = await showConfirmDialog('确定要恢复到【文生视频】参数的初始值吗？当前设置将会丢失。');
            if (confirmed) {
                // 显示加载状态
                showLoading(true);
                
                try {
                    const response = await fetch('/config/reset/text_to_video', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (response.ok) {
                        // 刷新当前页面但保持在原位
                        location.reload(false);
                    } else {
                        showAutoCloseNotification('恢复初始值失败，请重试！', 'error');
                    }
                } catch (error) {
                    console.error('恢复初始值时发生错误:', error);
                    showAutoCloseNotification('恢复初始值时发生网络错误，请重试！', 'error');
                } finally {
                    // 隐藏加载状态
                    showLoading(false);
                }
            }
        });
        
        document.getElementById('resetImageToVideo').addEventListener('click', async function() {
            const confirmed = await showConfirmDialog('确定要恢复到【图生视频】参数的初始值吗？当前设置将会丢失。');
            if (confirmed) {
                // 显示加载状态
                showLoading(true);
                
                try {
                    const response = await fetch('/config/reset/image_to_video', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (response.ok) {
                        // 刷新当前页面但保持在原位
                        location.reload(false);
                    } else {
                        showAutoCloseNotification('恢复初始值失败，请重试！', 'error');
                    }
                } catch (error) {
                    console.error('恢复初始值时发生错误:', error);
                    showAutoCloseNotification('恢复初始值时发生网络错误，请重试！', 'error');
                } finally {
                    // 隐藏加载状态
                    showLoading(false);
                }
            }
        });
        
        document.getElementById('resetTextToAudio').addEventListener('click', async function() {
            const confirmed = await showConfirmDialog('确定要恢复到【文生音频】参数的初始值吗？当前设置将会丢失。');
            if (confirmed) {
                // 显示加载状态
                showLoading(true);
                
                try {
                    const response = await fetch('/config/reset/text_to_audio', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (response.ok) {
                        // 刷新当前页面但保持在原位
                        location.reload(false);
                    } else {
                        showAutoCloseNotification('恢复初始值失败，请重试！', 'error');
                    }
                } catch (error) {
                    console.error('恢复初始值时发生错误:', error);
                    showAutoCloseNotification('恢复初始值时发生网络错误，请重试！', 'error');
                } finally {
                    // 隐藏加载状态
                    showLoading(false);
                }
            }
        });
        

    </script>

    <!-- 引入公共组件 -->
    {% include 'components/notification.html' %}

    <!-- 引入任务模态框 -->
    {% include 'components/task_modal.html' %}
    
    <!-- 引入页脚组件 -->
    {% include 'components/footer.html' %}
    
    <script>
        // Tab 切换功能
        function openTab(evt, tabName) {
            // 隐藏所有 tab 内容
            var tabcontent = document.getElementsByClassName("tab-content");
            for (var i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            // 重置所有 tab 按钮样式
            var tablinks = document.getElementsByClassName("tab-btn");
            for (var i = 0; i < tablinks.length; i++) {
                tablinks[i].style.backgroundColor = "#ccc";
                tablinks[i].style.color = "#333";
            }
            
            // 显示当前 tab 内容并设置按钮样式
            document.getElementById(tabName).style.display = "block";
            if (evt) {
                evt.currentTarget.style.backgroundColor = "#4a6fa5";
                evt.currentTarget.style.color = "white";
            } else {
                // 如果没有事件对象，手动触发对应按钮的点击事件
                const buttons = document.querySelectorAll('.tab-btn');
                for (let i = 0; i < buttons.length; i++) {
                    if (buttons[i].getAttribute('onclick').includes(tabName)) {
                        buttons[i].style.backgroundColor = "#4a6fa5";
                        buttons[i].style.color = "white";
                        break;
                    }
                }
            }
            
            // 记住当前选中的tab
            localStorage.setItem('lastActiveTab', tabName);
        }
        
        // 页面加载时恢复之前的tab
        document.addEventListener('DOMContentLoaded', function() {
            // 首先检查URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            
            let activeTab = 'textToImage'; // 默认tab
            
            // 优先级：URL参数 > localStorage > 默认值
            if (tabParam && document.getElementById(tabParam)) {
                activeTab = tabParam;
            } else if (localStorage.getItem('lastActiveTab')) {
                const lastTab = localStorage.getItem('lastActiveTab');
                if (document.getElementById(lastTab)) {
                    activeTab = lastTab;
                }
            }
            
            // 隐藏所有tab内容，确保不会同时显示多个tab
            const tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].style.display = "none";
            }
            
            // 打开选中的tab
            openTab(null, activeTab);
            
            // 处理所有cfg参数输入框，限制小数位数
            const cfgInputs = document.querySelectorAll('input[name$="[cfg]"]');
            cfgInputs.forEach(input => {
                // 设置初始值的小数位数
                if (input.value) {
                    input.value = parseFloat(input.value).toFixed(2);
                }
                
                // 记录用户是否正在输入中
                let isTyping = false;
                let lastInputTime = 0;
                
                // 添加keydown事件监听器，更好地支持键盘输入
                input.addEventListener('keydown', function() {
                    isTyping = true;
                    lastInputTime = Date.now();
                });
                
                // 添加input事件监听器，改进的小数位数处理
                input.addEventListener('input', function() {
                    // 允许空值
                    if (!this.value) {
                        return;
                    }
                    
                    // 处理纯小数点输入
                    if (this.value === '.') {
                        this.value = '0.';
                        return;
                    }
                    
                    // 验证是否是有效的数字格式
                    if (!/^\d*\.?\d*$/.test(this.value)) {
                        // 保留有效部分
                        this.value = this.value.replace(/[^\d.]/g, '');
                        // 确保只有一个小数点
                        const parts = this.value.split('.');
                        if (parts.length > 2) {
                            this.value = parts[0] + '.' + parts.slice(1).join('');
                        }
                    }
                    
                    // 检查是否是用户直接输入或增减按钮操作
                    const now = Date.now();
                    // 如果用户正在输入或最近有键盘输入，不立即格式化
                    if (isTyping || (now - lastInputTime < 500)) {
                        // 保留原始输入值，但最多保留2位小数
                        const value = parseFloat(this.value);
                        if (!isNaN(value)) {
                            // 提取小数点后的部分
                            const decimalPart = this.value.split('.')[1];
                            if (decimalPart && decimalPart.length > 2) {
                                // 只保留2位小数
                                this.value = value.toFixed(2);
                            }
                        }
                    } else {
                        // 自动格式化显示为2位小数
                        const value = parseFloat(this.value);
                        if (!isNaN(value)) {
                            this.value = value.toFixed(2);
                        }
                    }
                });
                
                // 添加blur事件监听器，最终确定保留2位小数
                input.addEventListener('blur', function() {
                    if (this.value && !isNaN(parseFloat(this.value))) {
                        this.value = parseFloat(this.value).toFixed(2);
                        isTyping = false;
                    }
                });
                
                // 添加focus事件监听器，允许编辑完整值
                input.addEventListener('focus', function() {
                    isTyping = true;
                });
                
                // 添加鼠标离开事件监听器
                input.addEventListener('mouseleave', function() {
                    // 延迟确认，让用户有时间使用增减按钮
                    setTimeout(() => {
                        if (this.value && !isNaN(parseFloat(this.value))) {
                            this.value = parseFloat(this.value).toFixed(2);
                        }
                    }, 100);
                });
            });
            
            // 在表单提交前对所有cfg参数进行处理
            const configForm = document.querySelector('form');
            if (configForm) {
                configForm.addEventListener('submit', function() {
                    const cfgInputs = document.querySelectorAll('input[name$="[cfg]"]');
                    cfgInputs.forEach(input => {
                        if (input.value && !isNaN(parseFloat(input.value))) {
                            input.value = parseFloat(input.value).toFixed(2);
                        }
                    });
                });
            }
        });
        
        // 检查URL可用性（增强版）
        async function checkUrlAvailability(url) {
            try {
                // 为了避免CORS问题，设置超时时间为5秒
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                // 首先检查基本连接性
                const connectResponse = await fetch(url, {
                    method: 'HEAD',
                    mode: 'cors',
                    credentials: 'omit',
                    signal: controller.signal,
                    headers: {
                        'Accept': '*/*'
                    }
                });
                
                clearTimeout(timeoutId);
                
                // 检查基本连接是否成功
                if (!(connectResponse.ok || connectResponse.redirected)) {
                    return false;
                }
                
                // 重置控制器，准备下一步检查
                const apiController = new AbortController();
                const apiTimeoutId = setTimeout(() => apiController.abort(), 5000);
                
                // 尝试访问ComfyUI的API端点以验证它是否为有效的ComfyUI服务
                // 先尝试获取ComfyUI常见的API端点信息
                try {
                    // 检查/workflow API，这是ComfyUI提供的常见端点
                    const apiResponse = await fetch(url + '/workflow', {
                        method: 'GET',
                        mode: 'cors',
                        credentials: 'omit',
                        signal: apiController.signal,
                        headers: {
                            'Accept': '*/*'
                        }
                    });
                    
                    clearTimeout(apiTimeoutId);
                    
                    // 检查响应是否表明这是一个有效的ComfyUI API
                    // 这里我们检查是否是JSON响应，并且是否包含ComfyUI特有的结构
                    const contentType = apiResponse.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            const data = await apiResponse.json();
                            // ComfyUI的/workflow端点通常返回包含nodes和links的对象
                            if (typeof data === 'object' && data !== null) {
                                return true;
                            }
                        } catch (jsonError) {
                            // 如果JSON解析失败，继续尝试其他检查方式
                            console.log('JSON解析失败，但URL仍然可达');
                        }
                    }
                } catch (apiError) {
                    console.log('API端点检查失败，但URL仍然可达');
                }
                
                // 如果上面的API检查失败，但URL本身是可达的，我们也认为它可能是一个有效的ComfyUI服务
                // 因为不同版本的ComfyUI可能有不同的API端点结构
                return true;
            } catch (error) {
                console.error('URL可用性检查失败:', error);
                return false;
            }
        }
        
        // 为表单添加提交事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            const configForm = document.querySelector('form');
            
            if (configForm) {
                configForm.addEventListener('submit', async function(e) {
                    // 获取ComfyUI API URL的值
                    const comfyuiApiUrl = document.getElementById('comfyui_api_url').value.trim();
                    
                    // 简单验证URL格式
                    if (comfyuiApiUrl && comfyuiApiUrl.startsWith('http')) {
                        // 显示加载状态
                        showLoading(true);
                        
                        try {
                            // 检查URL可用性
                            const isAvailable = await checkUrlAvailability(comfyuiApiUrl);
                            
                            // 隐藏加载状态
                            showLoading(false);
                            
                            if (!isAvailable) {
                                // URL不可用，显示弹框提示并阻止表单提交
                                e.preventDefault();
                                showNotification('ComfyUI API URL不可用，请检查地址是否正确！', 'error');
                            }
                        } catch (error) {
                            // 隐藏加载状态
                            showLoading(false);
                            console.error('检查URL可用性时发生错误:', error);
                            
                            // 默认允许提交，因为网络错误可能是临时的
                            showNotification('URL可用性检查过程中发生错误，将继续提交配置...', 'warning');
                        }
                    }
                });
            }
        });
        
        // 参数说明功能
        document.addEventListener('DOMContentLoaded', function() {
            // 加载参数说明配置文件
            fetch('/configs/node_notes.json')
                .then(response => response.json())
                .then(paramExplanations => {
                    // 存储参数说明数据
                    window.paramExplanations = paramExplanations;
                    
                    // 为所有参数标签添加说明标签
                    addParamTooltips();
                })
                .catch(error => {
                    console.error('加载参数说明配置文件失败:', error);
                });
        });
        
        // 为参数标签添加说明标签
        function addParamTooltips() {
            // 查找所有的参数标签
            const paramLabels = document.querySelectorAll('.form-group label');
            
            paramLabels.forEach(label => {
                // 获取参数ID
                const forAttr = label.getAttribute('for');
                if (!forAttr) return;
                
                // 确定参数类型和名称
                let paramType = 'common';
                let paramName = forAttr;
                
                // 特殊处理采样算法参数
                if (forAttr.endsWith('_sampler')) {
                    paramType = 'common';
                    paramName = 'sampler_name';
                } 
                // 特殊处理帧率参数
                else if (forAttr === 'fps') {
                    paramType = 'to_video';
                    paramName = 'fps';
                } 
                // 根据ID前缀判断参数所属类型
                else if (forAttr.startsWith('tti_') || forAttr.startsWith('iti_')) {
                    paramType = 'to_image';
                    paramName = forAttr.substring(4);
                } else if (forAttr.startsWith('ttv_') || forAttr.startsWith('itv_')) {
                    paramType = 'to_video';
                    paramName = forAttr.substring(4);
                } else if (forAttr.startsWith('tta_')) {
                    paramType = 'to_audio';
                    paramName = forAttr.substring(4);
                } else if (['comfyui_api_url', 'nickname', 'email'].includes(forAttr)) {
                    paramType = 'system';
                    paramName = forAttr;
                }
                
                // 获取参数说明
                let explanation = '';
                if (window.paramExplanations && window.paramExplanations[paramType] && window.paramExplanations[paramType][paramName]) {
                    explanation = window.paramExplanations[paramType][paramName];
                } else if (window.paramExplanations && window.paramExplanations.common && window.paramExplanations.common[paramName]) {
                    explanation = window.paramExplanations.common[paramName];
                }
                
                // 如果有说明，添加标签
                if (explanation) {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'param-tooltip';
                    tooltip.innerHTML = `
                        <div class="param-icon">?</div>
                        <div class="param-content">${explanation}</div>
                    `;
                    label.appendChild(tooltip);
                }
            });
        }
    </script>
</body>
</html>