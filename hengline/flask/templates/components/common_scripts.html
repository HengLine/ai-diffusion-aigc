<!-- 通用JavaScript功能组件 -->
<script>
/**
 * 显示自动关闭的通知
 * @param {string} message - 通知消息
 * @param {string} type - 通知类型：success, error, info, warning
 * @param {number} duration - 显示持续时间（毫秒）
 */
function showNotification(message, type = 'info', duration = 3000) {
    // 确保notification组件已加载
    if (!window.showAutoCloseNotification) {
        console.warn('Notification system not initialized');
        // 作为后备方案，仍然使用alert以确保消息能被用户看到
        alert(message);
        return;
    }
    
    window.showAutoCloseNotification(message, type, duration);
}

/**
 * 发送AJAX请求
 * @param {string} url - 请求URL
 * @param {Object} options - 请求选项
 * @returns {Promise} 请求结果Promise
 */
async function ajaxRequest(url, options = {}) {
    try {
        const defaultOptions = {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        };
        
        const mergedOptions = { ...defaultOptions, ...options };
        
        // 如果有body并且是对象，转换为JSON字符串
        if (mergedOptions.body && typeof mergedOptions.body === 'object') {
            mergedOptions.body = JSON.stringify(mergedOptions.body);
        }
        
        const response = await fetch(url, mergedOptions);
        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        // 尝试解析JSON响应
        try {
            return await response.json();
        } catch (e) {
            return await response.text();
        }
    } catch (error) {
        showNotification(`请求失败: ${error.message}`, 'error');
        throw error;
    }
}

/**
 * 提交表单数据
 * @param {string} url - 提交URL
 * @param {FormData|Object} data - 表单数据
 * @param {string} method - 请求方法
 * @returns {Promise} 提交结果Promise
 */
async function submitForm(url, data, method = 'POST') {
    try {
        const options = {
            method,
            credentials: 'same-origin'
        };
        
        // 如果是FormData对象，直接使用
        if (data instanceof FormData) {
            options.body = data;
            // 移除Content-Type，让浏览器自动设置
            options.headers = {};
        } else if (typeof data === 'object') {
            // 否则转换为JSON
            options.headers = {
                'Content-Type': 'application/json'
            };
            options.body = JSON.stringify(data);
        }
        
        const response = await fetch(url, options);
        
        if (!response.ok) {
            throw new Error(`提交失败! Status: ${response.status}`);
        }
        
        // 尝试解析JSON响应
        try {
            return await response.json();
        } catch (e) {
            // 如果不是JSON，返回成功状态（因为表单提交通常会重定向或刷新页面）
            return { success: true };
        }
    } catch (error) {
        showNotification(`提交失败: ${error.message}`, 'error');
        throw error;
    }
}

/**
 * 显示自定义确认对话框
 * @param {string} message - 确认消息
 * @param {Object} options - 可选配置
 * @returns {Promise<boolean>} 用户的选择（确认/取消）
 */
function showConfirmDialog(message, options = {}) {
    return new Promise((resolve) => {
        // 创建确认对话框容器
        const dialogContainer = document.createElement('div');
        dialogContainer.className = 'custom-confirm-dialog';
        dialogContainer.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        `;
        
        // 创建对话框内容
        const dialogContent = document.createElement('div');
        dialogContent.style.cssText = `
            background-color: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        `;
        
        // 创建消息元素
        const messageElement = document.createElement('p');
        messageElement.textContent = message;
        messageElement.style.cssText = `
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.5;
            color: #333;
        `;
        
        // 创建按钮容器
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        `;
        
        // 创建取消按钮
        const cancelButton = document.createElement('button');
        cancelButton.textContent = options.cancelText || '取消';
        cancelButton.style.cssText = `
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        `;
        
        // 创建确认按钮
        const confirmButton = document.createElement('button');
        confirmButton.textContent = options.confirmText || '确定';
        confirmButton.style.cssText = `
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #4a6fa5;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        `;
        
        // 添加动画样式
        const styleElement = document.createElement('style');
        styleElement.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            @keyframes slideOut {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-20px);
                }
            }
        `;
        document.head.appendChild(styleElement);
        
        // 添加事件监听
        cancelButton.addEventListener('click', () => {
            cleanup();
            resolve(false);
        });
        
        confirmButton.addEventListener('click', () => {
            cleanup();
            resolve(true);
        });
        
        // 点击背景关闭对话框
        dialogContainer.addEventListener('click', (e) => {
            if (e.target === dialogContainer) {
                cleanup();
                resolve(false);
            }
        });
        
        // 清理函数
        function cleanup() {
            dialogContainer.style.animation = 'fadeOut 0.3s ease';
            dialogContent.style.animation = 'slideOut 0.3s ease';
            
            setTimeout(() => {
                document.body.removeChild(dialogContainer);
                document.head.removeChild(styleElement);
            }, 300);
        }
        
        // 组装对话框
        buttonContainer.appendChild(cancelButton);
        buttonContainer.appendChild(confirmButton);
        dialogContent.appendChild(messageElement);
        dialogContent.appendChild(buttonContainer);
        dialogContainer.appendChild(dialogContent);
        
        // 添加到文档
        document.body.appendChild(dialogContainer);
    });
}

/**
 * 处理文件上传预览
 * @param {HTMLInputElement} inputElement - 文件输入元素
 * @param {HTMLImageElement} previewElement - 预览图像元素
 */
function setupFilePreview(inputElement, previewElement) {
    if (!inputElement || !previewElement) return;
    
    inputElement.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(event) {
                previewElement.src = event.target.result;
                previewElement.style.display = 'block';
            }
            
            reader.readAsDataURL(e.target.files[0]);
        }
    });
}

/**
 * 显示加载状态
 * @param {boolean} isLoading - 是否显示加载状态
 * @param {HTMLElement} targetElement - 目标元素
 */
function showLoading(isLoading, targetElement = document.body) {
    let loadingElement = document.getElementById('globalLoading');
    
    if (!loadingElement) {
        // 创建加载元素
        loadingElement = document.createElement('div');
        loadingElement.id = 'globalLoading';
        loadingElement.className = 'global-loading';
        loadingElement.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 9999;
            display: none;
        `;
        loadingElement.innerHTML = `
            <div class="loading-spinner"></div>
            <div>处理中...</div>
        `;
        document.body.appendChild(loadingElement);
    }
    
    loadingElement.style.display = isLoading ? 'block' : 'none';
}

/**
 * 生成唯一ID
 * @returns {string} 唯一ID
 */
function generateUniqueId() {
    return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

/**
 * 防抖函数
 * @param {Function} func - 要防抖的函数
 * @param {number} wait - 等待时间（毫秒）
 * @returns {Function} 防抖后的函数
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * 节流函数
 * @param {Function} func - 要节流的函数
 * @param {number} limit - 限制时间（毫秒）
 * @returns {Function} 节流后的函数
 */
function throttle(func, limit) {
    let inThrottle;
    return function(...args) {
        if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

/**
 * 设置参数折叠/展开功能
 */
function setupParameterFolding() {
    const parameterGroups = document.querySelectorAll('.parameter-group');
    parameterGroups.forEach(group => {
        const header = group.querySelector('h3');
        header.addEventListener('click', () => {
            group.classList.toggle('collapsed');
        });
    });
}

/**
 * 同步滑块和输入框的值
 * @param {string} sliderId - 滑块元素ID
 * @param {string} inputId - 输入框元素ID
 */
function setupSliderSync(sliderId, inputId) {
    const slider = document.getElementById(sliderId);
    const input = document.getElementById(inputId);
    
    if (slider && input) {
        // 当滑块值变化时更新输入框
        slider.addEventListener('input', function() {
            // 设置滑块值时，根据步长设置合适的小数位数
            const step = parseFloat(input.step) || 1;
            const decimalPlaces = step.toString().split('.')[1] ? step.toString().split('.')[1].length : 0;
            const value = parseFloat(this.value);
            input.value = value.toFixed(decimalPlaces);
        });
        
        // 当输入框值变化时更新滑块
        input.addEventListener('input', function() {
            // 允许空值
            if (!this.value) {
                return;
            }
            
            // 处理纯小数点输入
            if (this.value === '.') {
                this.value = '0.';
                return;
            }
            
            // 验证是否是有效的数字格式
            if (!/^\d*\.?\d*$/.test(this.value)) {
                // 不是有效的数字格式，恢复之前的值
                const currentValue = this.value;
                setTimeout(() => {
                    this.value = currentValue.replace(/[^\d.]/g, '');
                }, 0);
                return;
            }
            
            // 限制小数点的数量
            const parts = this.value.split('.');
            if (parts.length > 2) {
                this.value = parts[0] + '.' + parts.slice(1).join('');
                return;
            }
            
            // 确保值在有效范围内
            const min = parseFloat(this.min);
            const max = parseFloat(this.max);
            const step = parseFloat(this.step);
            let value = parseFloat(this.value);
            
            if (isNaN(value)) value = min;
            if (value < min) value = min;
            if (value > max) value = max;
            
            // 根据步长调整值
            value = Math.round(value / step) * step;
            
            // 设置小数位数
            const decimalPlaces = step.toString().split('.')[1] ? step.toString().split('.')[1].length : 0;
            this.value = value.toFixed(decimalPlaces);
            slider.value = value;
        });
    }
}

/**
 * 初始化数字输入框，支持小数输入和限制小数位数
 * @param {HTMLFormElement} form - 表单元素（可选）
 */
function initNumberInputs(form) {
    const numberInputs = form ? form.querySelectorAll('input[type="number"]') : document.querySelectorAll('input[type="number"]');
    numberInputs.forEach(input => {
        // 记录用户是否正在输入中
        let isTyping = false;
        let lastInputTime = 0;
        
        // 设置初始值的小数位数
        if (input.value && !isNaN(parseFloat(input.value))) {
            const step = parseFloat(input.step) || 1;
            const decimalPlaces = step.toString().split('.')[1] ? step.toString().split('.')[1].length : 0;
            input.value = parseFloat(input.value).toFixed(decimalPlaces);
        }
        
        // 添加keydown事件监听器，更好地支持键盘输入
        input.addEventListener('keydown', function() {
            isTyping = true;
            lastInputTime = Date.now();
        });
        
        // 添加focus事件监听器
        input.addEventListener('focus', function() {
            isTyping = true;
        });
        
        // 添加blur事件监听器
        input.addEventListener('blur', function() {
            isTyping = false;
            // 当失去焦点时，如果有值，则格式化显示
            if (this.value && !isNaN(parseFloat(this.value))) {
                const step = parseFloat(this.step) || 1;
                const decimalPlaces = step.toString().split('.')[1] ? step.toString().split('.')[1].length : 0;
                this.value = parseFloat(this.value).toFixed(decimalPlaces);
            }
        });
        
        // 添加mouseleave事件监听器
        input.addEventListener('mouseleave', function() {
            // 延迟100毫秒，确保用户操作完成
            setTimeout(() => {
                if (!isTyping && this.value && !isNaN(parseFloat(this.value))) {
                    const step = parseFloat(this.step) || 1;
                    const decimalPlaces = step.toString().split('.')[1] ? step.toString().split('.')[1].length : 0;
                    this.value = parseFloat(this.value).toFixed(decimalPlaces);
                }
            }, 100);
        });
        
        // 改进的input事件处理
        input.addEventListener('input', function() {
            // 允许空值
            if (!this.value) {
                return;
            }
            
            // 处理纯小数点输入
            if (this.value === '.') {
                this.value = '0.';
                return;
            }
            
            // 验证是否是有效的数字格式
            if (!/^\d*\.?\d*$/.test(this.value)) {
                // 不是有效的数字格式，恢复之前的值
                const currentValue = this.value;
                setTimeout(() => {
                    this.value = currentValue.replace(/[^\d.]/g, '');
                }, 0);
                return;
            }
            
            // 限制小数点的数量
            const parts = this.value.split('.');
            if (parts.length > 2) {
                this.value = parts[0] + '.' + parts.slice(1).join('');
                return;
            }
            
            // 判断是否为用户主动输入，还是滑块联动导致的输入
            const isUserTyping = isTyping && (Date.now() - lastInputTime < 200);
            
            // 如果是用户主动输入，不进行实时格式化，只在输入完成后处理
            if (isUserTyping) {
                return;
            }
            
            // 如果是滑块联动或增减按钮导致的输入，则进行实时格式化
            if (!isNaN(parseFloat(this.value))) {
                const step = parseFloat(this.step) || 1;
                const decimalPlaces = step.toString().split('.')[1] ? step.toString().split('.')[1].length : 0;
                this.value = parseFloat(this.value).toFixed(decimalPlaces);
            }
        });
    });
    
    // 如果提供了表单元素，添加表单提交前的处理
    if (form) {
        form.addEventListener('submit', function(e) {
            // 处理所有数字输入框的值
            const formNumberInputs = form.querySelectorAll('input[type="number"]');
            formNumberInputs.forEach(input => {
                if (input.value && !isNaN(parseFloat(input.value))) {
                    const step = parseFloat(input.step) || 1;
                    const decimalPlaces = step.toString().split('.')[1] ? step.toString().split('.')[1].length : 0;
                    input.value = parseFloat(input.value).toFixed(decimalPlaces);
                }
            });
        }, false);
    }
}
</script>