<!-- 我的任务模态框 -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>我的任务</h2>
            <div class="filter-group">
                <div class="date-filter">
                    <label for="taskDateFilter">提交日期：</label>
                    <input type="date" id="taskDateFilter" name="taskDateFilter" value="" max="" placeholder="选择日期">
                </div>
                <div class="status-filter">
                    <label for="taskStatusFilter">任务状态：</label>
                    <select id="taskStatusFilter" name="taskStatusFilter">
                        <option value="all">全部状态</option>
                        <option value="queued">排队中</option>
                        <option value="running">运行中</option>
                        <option value="success">完成</option>
                        <option value="failed">失败</option>
                    </select>
                </div>
                <div class="type-filter">
                    <label for="taskTypeFilter">任务类型：</label>
                    <select id="taskTypeFilter" name="taskTypeFilter">
                        <option value="all">全部类型</option>
                        <option value="text_to_image">文生图</option>
                        <option value="image_to_image">图生图</option>
                        <option value="text_to_video">文生视频</option>
                        <option value="image_to_video">图生视频</option>
                        <option value="text_to_audio">文生音频</option>
                    </select>
                </div>
            </div>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div id="taskList">
                <!-- 任务列表将通过JavaScript动态加载 -->
                <div class="loading">加载任务列表中...</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="close-button">关闭</button>
        </div>
    </div>
</div>

<style>
    /* 模态框样式 */
    .modal {
        display: none; /* 默认隐藏 */
        position: fixed; /* 固定定位 */
        z-index: 1000; /* 置于顶层 */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0,0,0);
        background-color: rgba(0,0,0,0.4);
        padding-top: 60px;
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: -1% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 900px;
        max-height: 90vh;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
    }
    
    .modal-header {
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
    }
    
    /* 筛选器样式 */
        .filter-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .filter-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
        
        /* 日期选择框样式 */
        .date-filter {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .date-filter label {
            font-size: 0.9rem;
            color: #495057;
        }
        
        .date-filter input[type="date"] {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        /* 状态筛选样式 */
        .status-filter {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* 类型筛选样式 */
        .type-filter {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-filter label,
            .type-filter label {
            font-size: 0.9rem;
            color: #495057;
        }
        
        .status-filter select,
        .type-filter select {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
            background-color: white;
        }
    
    .modal-header h2 {
        margin: 0;
        color: #2c3e50;
    }
    
    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }
    
    .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 6px 0;
    }
    
    .modal-footer {
        padding: 10px 0;
        border-top: 1px solid #e9ecef;
        display: flex;
        justify-content: flex-end;
    }
    
    .close-button {
        background-color: #4a6fa5;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .close-button:hover {
        background-color: #3a5a85;
    }
    
    /* 任务列表样式 */
    .task-item {
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid #e9ecef;
        background-color: #f8f9fa;
    }
    
    .task-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .task-type {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .task-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .status-queued {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-running {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    
    .status-completed {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-failed {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .task-details {
        margin-bottom: 10px;
    }
    
    .task-prompt {
        font-size: 0.95rem;
        color: #6c757d;
        word-break: break-word;
        margin-bottom: 5px;
    }
    
    .task-info {
        font-size: 0.85rem;
        color: #868e96;
        margin-bottom: 5px;
    }
    
    .task-actions {
        display: flex;
        gap: 10px;
    }
    
    .view-result-button {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
    }
    
    .view-result-button:hover {
        background-color: #218838;
    }
    
    .loading {
        text-align: center;
        padding: 20px;
        color: #6c757d;
    }
    
    .no-tasks {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    /* 结果模态框样式 */
    .result-modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0,0,0);
        background-color: rgba(0,0,0,0.9);
        padding-top: 60px;
    }
    
    .result-info {
        margin-bottom: 20px;
        padding: 15px;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }
    
    .result-info p {
        margin: 8px 0;
        color: #18334e;
    }
    
    .result-counter {
        font-weight: bold;
        color: #4a6fa5 !important;
    }
    
    .result-content {
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
    }
    
    /* 音频播放器特定样式 */
    .result-content audio {
        max-width: 100%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-radius: 4px;
    }
    
    /* 图片轮播样式 */
    .result-carousel {
        position: relative;
        width: 100%;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .carousel-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        max-width: 600px;
    }
    
    .carousel-button {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: rgba(74, 111, 165, 0.8);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        z-index: 10;
    }
    
    .prev-button {
        left: 10px;
    }
    
    .next-button {
        right: 10px;
    }
    
    .carousel-button:hover {
        background-color: rgba(58, 90, 133, 0.9);
    }
    
    /* 下载按钮样式 */
    .result-actions {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }
    
    .download-button {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }
    
    .download-button:hover {
        background-color: #218838;
    }
    
    /* 加载动画样式 */
    .loading {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 40px;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4a6fa5;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
    function formatDate(dateTime) {
        const date = new Date(+new Date(dateTime) + 8 * 3600 * 1000); // 加8小时
        return date.toISOString().split('T')[0];
    }
    document.addEventListener('DOMContentLoaded', function() {
        // 获取模态框元素
        const taskModal = document.getElementById('taskModal');
        const closeButtons = document.querySelectorAll('.close, .close-button');
        const taskList = document.getElementById('taskList');
        
        // 打开模态框
        // 修改openTaskModal函数以接受taskType参数
        window.openTaskModal = function(taskType) {
            taskModal.style.display = 'block';
            
            // 设置日期选择框默认值为今天
            const today = new Date();
            document.getElementById('taskDateFilter').value = formatDate(today);
            // 设置最大可选日期为今天
            document.getElementById('taskDateFilter').max = formatDate(today);
            
            // 添加日期变化事件监听
            document.getElementById('taskDateFilter').addEventListener('change', function() {
                loadTaskList();
            });
            
            // 添加状态变化事件监听
            document.getElementById('taskStatusFilter').addEventListener('change', function() {
                loadTaskList();
            });
            
            // 设置任务类型筛选框
            const taskTypeFilter = document.getElementById('taskTypeFilter');
            if (taskTypeFilter) {
                // 如果提供了taskType参数且存在对应的选项，则设置它
                if (taskType && taskType !== 'all') {
                    // 检查选择框是否包含该选项
                    const optionExists = Array.from(taskTypeFilter.options).some(option => option.value === taskType);
                    if (optionExists) {
                        taskTypeFilter.value = taskType;
                    }
                }
                
                // 添加类型变化事件监听
                taskTypeFilter.addEventListener('change', function() {
                    loadTaskList();
                });
            }
            
            loadTaskList();
        };
        
        // 关闭模态框
        function closeTaskModal() {
            taskModal.style.display = 'none';
        }
        
        // 为关闭按钮添加事件监听
        closeButtons.forEach(button => {
            button.addEventListener('click', closeTaskModal);
        });
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target === taskModal) {
                closeTaskModal();
            }
        });
        
        // 加载任务列表
        function loadTaskList() {
            taskList.innerHTML = '<div class="loading">加载任务列表中...</div>';
            
            // 获取选择的日期、状态和类型
            const selectedDate = document.getElementById('taskDateFilter').value;
            const selectedStatus = document.getElementById('taskStatusFilter').value;
            const selectedType = document.getElementById('taskTypeFilter').value;
            
            // 构建请求URL，添加日期、状态和类型参数
            let url = '/api/task_queue/all_tasks?';
            const params = [];
            
            if (selectedDate) {
                params.push('date=' + selectedDate);
            }
            
            if (selectedStatus && selectedStatus !== 'all') {
                params.push('status=' + selectedStatus);
            }
            
            if (selectedType && selectedType !== 'all') {
                params.push('task_type=' + selectedType);
            }
            
            url += params.join('&');
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const tasks = data.data;
                        
                        if (tasks.length === 0) {
                            taskList.innerHTML = '<div class="no-tasks">暂无任务记录</div>';
                            return;
                        }
                        
                        let taskHTML = '';
                        tasks.forEach(task => {
                            // 格式化时间
                            const createTime = new Date(task.timestamp * 1000).toLocaleString('zh-CN');
                            let startTime = '-';
                            let endTime = '-';
                            let duration = '-';
                            
                            if (task.start_time) {
                                startTime = new Date(task.start_time * 1000).toLocaleString('zh-CN');
                            }
                            
                            if (task.end_time) {
                                endTime = new Date(task.end_time * 1000).toLocaleString('zh-CN');
                                if (task.start_time) {
                                    duration = Math.round(task.duration) + '秒';
                                }
                            }
                            
                            // 获取任务类型的中文名称
                            const taskTypeNames = {
                                'text_to_image': '文生图',
                                'image_to_image': '图生图',
                                'text_to_video': '文生视频',
                                'image_to_video': '图生视频',
                                'text_to_audio': '文生音频'
                            };
                            
                            const taskTypeName = taskTypeNames[task.task_type] || task.task_type;
                            
                            // 构建任务项HTML
                            taskHTML += `
                                <div class="task-item">
                                    <div class="task-item-header">
                                        <span class="task-type">${taskTypeName}</span>
                                        <span class="task-status status-${task.status}">${getStatusText(task.status)}</span>
                                    </div>
                                    <div class="task-details">
                                        <div class="task-prompt">任务ID: ${task.task_id || '无'}</div>
                                        <div class="task-prompt">提示词: ${task.prompt || '无'}</div>
                                        <div class="task-info">创建时间: ${createTime}</div>
                                        <div class="task-info">开始时间: ${startTime}</div>
                                        <div class="task-info">结束时间: ${endTime}</div>
                                        <div class="task-info">执行时长: ${duration}</div>
                                        ${task.task_msg && task.status === 'failed' ? '<div class="task-info task-message" style="color: #dc3545;"> ' + task.task_msg + '</div>' : ''}
                                        ${task.task_msg && task.status != 'failed' ? '<div class="task-info task-message" style="color: #409C25;"> ' + task.task_msg + '</div>' : ''}
                                    </div>
                                    <div class="task-actions">
                                        ${task.status === 'success' ? 
                                            '<button class="view-result-button" onclick="viewTaskResult(\'' + task.task_id + '\')">查看结果</button>' : 
                                            ''
                                        }
                                    </div>
                                </div>
                            `;
                        });
                        
                        taskList.innerHTML = taskHTML;
                    } else {
                        taskList.innerHTML = '<div class="error">加载任务失败: ' + (data.message || '未知错误') + '</div>';
                    }
                })
                .catch(error => {
                    console.error('加载任务列表失败:', error);
                    taskList.innerHTML = '<div class="error">加载任务列表失败，请刷新页面重试</div>';
                });
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const statusTexts = {
                'queued': '排队中',
                'running': '运行中',
                'success': '完成',
                'failed': '失败'
            };
            return statusTexts[status] || status;
        }
        
        // 查看任务结果
        window.viewTaskResult = function(taskId) {
            try {
                // 验证任务ID
                if (!taskId || typeof taskId !== 'string') {
                    console.error('无效的任务ID:', taskId);
                    showNotification('无效的任务ID', 'error', 3000);
                    return;
                }
                
                // 显示加载动画
                const loading = document.createElement('div');
                loading.className = 'loading';
                loading.innerHTML = '<div class="spinner"></div><p>加载中...</p>';
                document.body.appendChild(loading);
                
                // 获取任务结果
                fetch(`/api/task_queue/result/${taskId}`)
                    .then(response => {
                        document.body.removeChild(loading);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data && data.success && data.data) {
                            const resultData = data.data || {};
                            
                            // 验证必要数据存在性
                            if (!resultData) {
                                throw new Error('任务结果数据为空');
                            }
                            
                            // 解析文件名和扩展名
                            let mainResultUrl = '';
                            let baseName = '';
                            let extension = '';
                            
                            // 使用后端提供的result_urls数组
                            const resultUrls = Array.isArray(resultData.result_urls) ? resultData.result_urls : [];
                            const filenames = Array.isArray(resultData.filenames) ? resultData.filenames : [];
                            
                            // 安全获取和设置mainResultUrl
                            if (resultUrls.length > 0) {
                                mainResultUrl = resultUrls[0];
                            } else if (resultData.filename) {
                                mainResultUrl = '/outputs/' + resultData.filename;
                                // 解析文件名以查找可能的多个结果（向后兼容）
                                baseName = resultData.filename.replace(/\.[^/.]+$/, "");
                                extension = resultData.filename.substring(resultData.filename.lastIndexOf('.'));
                            }
                            
                            // 创建结果模态框
                            const resultModal = document.createElement('div');
                            resultModal.className = 'modal';
                            resultModal.id = 'resultModal';
                            let resultContent = '';
                            
                            // 安全地获取任务信息，提供默认值
                            const taskType = resultData.task_type || 'unknown';
                            const prompt = resultData.prompt || '无';
                            const endTime = resultData.end_time ? new Date(resultData.end_time * 1000).toLocaleString('zh-CN') : '未知';
                            const resultCount = Math.max(resultUrls.length, 1);
                            
                            // 根据任务类型显示不同的结果
                            if (taskType.includes('video')) {
                                // 视频结果 - 假设只有一个视频结果
                                resultContent = `
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h2>任务结果</h2>
                                            <span class="close" onclick="document.getElementById('resultModal').remove()">&times;</span>
                                        </div>
                                        <div class="modal-body">
                                            <div class="result-info">
                                                <p><strong>任务类型:</strong> ${taskType}</p>
                                                <p><strong>提示词:</strong> ${prompt}</p>
                                                <p><strong>生成时间:</strong> ${endTime}</p>
                                                <p class="result-counter"><strong>当前结果:</strong> 1/${resultCount}</p>
                                            </div>
                                            <div class="result-content">
                                                <video controls style="width: 100%; max-height: 500px; object-fit: contain;">
                                                    <source src="${mainResultUrl}" type="video/mp4">
                                                    您的浏览器不支持视频播放
                                                </video>
                                            </div>
                                            <div class="result-actions">
                                                <a href="${mainResultUrl}" class="download-button" download>下载视频</a>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else if (taskType.includes('音频') || taskType.includes('audio')) {
                                // 音频结果
                                resultContent = `
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h2>任务结果</h2>
                                            <span class="close" onclick="document.getElementById('resultModal').remove()">&times;</span>
                                        </div>
                                        <div class="modal-body">
                                            <div class="result-info">
                                                <p><strong>任务类型:</strong> ${taskType}</p>
                                                <p><strong>提示词:</strong> ${prompt}</p>
                                                <p><strong>生成时间:</strong> ${endTime}</p>
                                                <p class="result-counter"><strong>当前结果:</strong> 1/${resultCount}</p>
                                            </div>
                                            <div class="result-carousel">
                                                <button class="carousel-button prev-button" onclick="showPreviousResult('${taskId}', this)">&lt;</button>
                                                <div class="carousel-container">
                                                    <audio id="result-audio-${taskId}" controls style="width: 100%;">
                                                        <source src="${mainResultUrl}" type="audio/mpeg">
                                                        您的浏览器不支持音频播放
                                                    </audio>
                                                </div>
                                                <button class="carousel-button next-button" onclick="showNextResult('${taskId}', this)">&gt;</button>
                                            </div>
                                            <div class="result-actions">
                                                <a id="download-link-${taskId}" href="${mainResultUrl}" class="download-button" download>下载音频</a>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                // 图像结果 - 支持多图轮播
                                resultContent = `
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h2>任务结果</h2>
                                            <span class="close" onclick="document.getElementById('resultModal').remove()">&times;</span>
                                        </div>
                                        <div class="modal-body">
                                            <div class="result-info">
                                                <p><strong>任务类型:</strong> ${taskType}</p>
                                                <p><strong>提示词:</strong> ${prompt}</p>
                                                <p><strong>生成时间:</strong> ${endTime}</p>
                                                <p class="result-counter"><strong>当前结果:</strong> 1/${resultCount}</p>
                                            </div>
                                            <div class="result-carousel">
                                                <button class="carousel-button prev-button" onclick="showPreviousResult('${taskId}', this)">&lt;</button>
                                                <div class="carousel-container">
                                                    <img id="result-image-${taskId}" src="${mainResultUrl}" style="max-width: 100%; max-height: 500px; display: block; margin: 0 auto;">
                                                </div>
                                                <button class="carousel-button next-button" onclick="showNextResult('${taskId}', this)">&gt;</button>
                                            </div>
                                            <div class="result-actions">
                                                <a id="download-link-${taskId}" href="${mainResultUrl}" class="download-button" download>下载图像</a>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            resultModal.innerHTML = resultContent;
                            document.body.appendChild(resultModal);
                            resultModal.style.display = 'block';
                            
                            // 保存任务数据到模态框的dataset中
                            resultModal.dataset.taskData = JSON.stringify({
                                resultUrls: resultUrls,
                                filenames: filenames
                            });
                            
                            // 点击模态框外部关闭
                            resultModal.addEventListener('click', function(event) {
                                if (event.target === resultModal) {
                                    resultModal.remove();
                                }
                            });
                            
                            // 初始化轮播数据（图像和音频任务）
                            if (!taskType.includes('video')) {
                                try {
                                    // 初始化轮播数据
                                    const carouselData = {
                                        currentIndex: 0,
                                        allResults: [],
                                        baseName: baseName,
                                        extension: extension,
                                        taskType: taskType
                                    };
                                    
                                    // 优先使用后端提供的resultUrls和filenames
                                    if (resultUrls.length > 0 && filenames.length > 0) {
                                        for (let i = 0; i < resultUrls.length && i < filenames.length; i++) {
                                            if (resultUrls[i] && filenames[i]) {
                                                carouselData.allResults.push({
                                                    url: resultUrls[i],
                                                    filename: filenames[i]
                                                });
                                            }
                                        }
                                    } else if (resultData.filename) {
                                        // 向后兼容：使用主结果URL和文件名
                                        carouselData.allResults = [{url: mainResultUrl, filename: resultData.filename}];
                                    } else {
                                        // 如果没有任何结果数据，显示空数组
                                        carouselData.allResults = [];
                                    }
                                    
                                    // 存储轮播数据
                                    resultModal.dataset.carouselData = JSON.stringify(carouselData);
                                    
                                    // 更新结果计数器
                                    const counter = resultModal.querySelector('.result-counter');
                                    if (counter) {
                                        counter.innerHTML = `<strong>当前结果:</strong> ${carouselData.currentIndex + 1}/${carouselData.allResults.length || 1}`;
                                    }
                                    
                                    // 如果只有一个结果或没有结果，隐藏导航按钮
                                    if (carouselData.allResults.length <= 1) {
                                        const prevButton = resultModal.querySelector('.prev-button');
                                        const nextButton = resultModal.querySelector('.next-button');
                                        if (prevButton) prevButton.style.display = 'none';
                                        if (nextButton) nextButton.style.display = 'none';
                                    }
                                } catch (carouselError) {
                                    console.error('初始化轮播数据失败:', carouselError);
                                    // 即使轮播初始化失败，也要确保模态框能正常显示
                                }
                            }
                        } else {
                            showNotification('获取任务结果失败: ' + (data && data.message || '未知错误'), 'error', 3000);
                        }
                    })
                    .catch(error => {
                        document.body.removeChild(loading);
                        console.error('获取任务结果失败:', error);
                        showNotification('获取任务结果失败，请稍后重试', 'error', 3000);
                    });
            } catch (error) {
                console.error('查看任务结果时发生错误:', error);
                // 移除可能存在的加载动画
                const loading = document.querySelector('.loading');
                if (loading) {
                    document.body.removeChild(loading);
                }
                showNotification('查看任务结果时发生错误，请稍后重试', 'error', 3000);
            }
        };
        
        // 查找任务的所有结果文件
        function findAllResultsForTask(taskId, baseName, extension, modal) {
            try {
                // 从模态框数据中获取后端提供的结果URLs和文件名
                const resultModal = document.getElementById('resultModal');
                if (!resultModal) return;
                
                // 获取从API获取的数据
                let taskData = {};
                if (resultModal.dataset.taskData) {
                    taskData = JSON.parse(resultModal.dataset.taskData);
                }
                const resultUrls = taskData.resultUrls || [];
                const filenames = taskData.filenames || [];
                
                // 使用后端提供的结果URLs和文件名
                const results = [];
                
                // 如果后端提供了resultUrls，则直接使用
                if (resultUrls.length > 0 && filenames.length > 0) {
                    for (let i = 0; i < resultUrls.length && i < filenames.length; i++) {
                        if (resultUrls[i] && filenames[i]) {
                            results.push({
                                url: resultUrls[i],
                                filename: filenames[i]
                            });
                        }
                    }
                } else if (baseName && extension) {
                    // 向后兼容：如果没有resultUrls，使用基础文件名
                    results.push({
                        url: '/outputs/' + baseName + extension,
                        filename: baseName + extension
                    });
                }
                
                // 更新轮播数据
                if (modal && modal.dataset.carouselData) {
                    const carouselData = JSON.parse(modal.dataset.carouselData);
                    carouselData.allResults = results;
                    modal.dataset.carouselData = JSON.stringify(carouselData);
                    
                    // 更新结果计数器
                    const counter = modal.querySelector('.result-counter');
                    if (counter) {
                        counter.innerHTML = `<strong>当前结果:</strong> ${carouselData.currentIndex + 1}/${carouselData.allResults.length}`;
                    }
                    
                    // 如果只有一个结果，隐藏导航按钮
                    if (results.length <= 1) {
                        const prevButton = modal.querySelector('.prev-button');
                        const nextButton = modal.querySelector('.next-button');
                        if (prevButton) prevButton.style.display = 'none';
                        if (nextButton) nextButton.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('查找任务结果文件时出错:', error);
            }
        }
        
        // 显示上一个结果
        window.showPreviousResult = function(taskId, button) {
            const modal = button.closest('.modal');
            if (!modal || !modal.dataset.carouselData) return;
            
            try {
                const carouselData = JSON.parse(modal.dataset.carouselData);
                
                // 检查结果数组是否存在且有多个结果
                if (!carouselData.allResults || carouselData.allResults.length <= 1) return;
                
                // 更新索引（循环）
                carouselData.currentIndex = (carouselData.currentIndex - 1 + carouselData.allResults.length) % carouselData.allResults.length;
                modal.dataset.carouselData = JSON.stringify(carouselData);
                
                // 更新显示
                updateCarouselDisplay(modal, carouselData);
            } catch (error) {
                console.error('切换到上一个结果时出错:', error);
            }
        };
        
        // 显示下一个结果
        window.showNextResult = function(taskId, button) {
            const modal = button.closest('.modal');
            if (!modal || !modal.dataset.carouselData) return;
            
            try {
                const carouselData = JSON.parse(modal.dataset.carouselData);
                
                // 检查结果数组是否存在且有多个结果
                if (!carouselData.allResults || carouselData.allResults.length <= 1) return;
                
                // 更新索引（循环）
                carouselData.currentIndex = (carouselData.currentIndex + 1) % carouselData.allResults.length;
                modal.dataset.carouselData = JSON.stringify(carouselData);
                
                // 更新显示
                updateCarouselDisplay(modal, carouselData);
            } catch (error) {
                console.error('切换到下一个结果时出错:', error);
            }
        };
        
        // 更新轮播显示
        function updateCarouselDisplay(modal, carouselData) {
            const currentResult = carouselData.allResults[carouselData.currentIndex];
            
            // 检查当前结果是否存在
            if (!currentResult) {
                console.warn('当前结果不存在，可能是数据加载问题');
                return;
            }
            
            // 更新图像 - 使用taskId查找元素
            const image = modal.querySelector('[id^="result-image-"]');
            if (image && currentResult.url) {
                image.src = currentResult.url;
            }
            
            // 更新音频 - 使用taskId查找元素
            const audio = modal.querySelector('[id^="result-audio-"]');
            if (audio && currentResult.url) {
                // 获取source元素
                const source = audio.querySelector('source');
                if (source) {
                    source.src = currentResult.url;
                    // 触发音频元素加载新资源
                    audio.load();
                }
            }
            
            // 更新下载链接 - 使用taskId查找元素
            const downloadLink = modal.querySelector('[id^="download-link-"]');
            if (downloadLink && currentResult.url && currentResult.filename) {
                downloadLink.href = currentResult.url;
                downloadLink.download = currentResult.filename;
            }
            
            // 更新计数器
            const counter = modal.querySelector('.result-counter');
            if (counter) {
                counter.innerHTML = `<strong>当前结果:</strong> ${carouselData.currentIndex + 1}/${carouselData.allResults.length}`;
            }
        };
        
        // 显示通知函数
        function showNotification(message, type = 'info', duration = 3000) {
            try {
                // 创建通知元素
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                
                // 设置通知样式
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.padding = '12px 24px';
                notification.style.borderRadius = '4px';
                notification.style.color = 'white';
                notification.style.fontWeight = 'bold';
                notification.style.zIndex = '9999';
                notification.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
                notification.style.animation = 'slideIn 0.3s ease-out';
                
                // 根据类型设置背景色
                switch (type) {
                    case 'error':
                        notification.style.backgroundColor = '#dc3545';
                        break;
                    case 'success':
                        notification.style.backgroundColor = '#28a745';
                        break;
                    case 'warning':
                        notification.style.backgroundColor = '#ffc107';
                        break;
                    default:
                        notification.style.backgroundColor = '#17a2b8';
                }
                
                // 添加到文档
                document.body.appendChild(notification);
                
                // 设置定时器自动移除
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, duration);
                
                // 添加通知样式到页面
                if (!document.getElementById('notificationStyles')) {
                    const style = document.createElement('style');
                    style.id = 'notificationStyles';
                    style.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                        @keyframes slideOut {
                            from { transform: translateX(0); opacity: 1; }
                            to { transform: translateX(100%); opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            } catch (error) {
                console.error('显示通知时出错:', error);
            }
        }
        
        // 结果模态框样式已在页面顶部定义，此处不再重复添加
    });
</script>