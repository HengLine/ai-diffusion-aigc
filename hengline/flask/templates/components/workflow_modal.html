<!-- 自定义工作流模态框 -->
<div id="workflowModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>自定义工作流</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="workflowType">工作流类型</label>
                <select id="workflowType" name="workflowType" disabled>
                    <option value="text_to_image">文生图</option>
                    <option value="image_to_image">图生图</option>
                    <option value="text_to_video">文生视频</option>
                    <option value="image_to_video">图生视频</option>
                    <option value="text_to_audio">文生音频</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="workflowPresets">选择应用工作流</label>
                <select id="workflowPresets" name="workflowPresets">
                    <option value="default" selected>默认工作流</option>
                    <!-- 工作流选项将通过JavaScript动态加载 -->
                </select>
                <small style="color: #666; display: block; margin-top: 0.25rem;">选择指定工作流后可以应用或修改，选择默认工作流后可新增或应用，点击应用后将直接使用该工作流</small>
            </div>
            
            <div class="form-group">
                <label for="workflowJson">工作流JSON配置</label>
                <textarea id="workflowJson" name="workflowJson" rows="15" placeholder="请输入标准的JSON格式工作流配置..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; box-sizing: border-box; font-family: monospace;"></textarea>
                <small style="color: #666; display: block; margin-top: 0.25rem;">请确保输入的JSON格式正确，当点击“应用”后将直接使用该工作流</small>
            </div>
            
            <div id="jsonError" style="color: #dc3545; font-size: 0.9rem; margin-top: 0.5rem; display: none;"></div>
        </div>
        <div class="modal-footer">
            <button id="saveWorkflowOnlyBtn" class="form-button">保存</button>
            <button id="saveAndApplyWorkflowBtn" class="form-button" style="background-color: #28a745; margin-left: 10px;">应用</button>
            <button class="close-button" style="margin-left: 10px;">取消</button>
        </div>
    </div>
</div>

<style>
    /* 模态框样式 */
    .modal {
        display: none; /* 默认隐藏 */
        position: fixed; /* 固定定位 */
        z-index: 1000; /* 置于顶层 */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0,0,0);
        background-color: rgba(0,0,0,0.4);
        padding-top: 60px;
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: -1% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 900px;
        max-height: 90vh;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
    }
    
    .modal-header {
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 10px 0;
    }
    
    .modal-footer {
        padding: 10px 0;
        border-top: 1px solid #e9ecef;
        display: flex;
        justify-content: flex-end;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover, .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        box-sizing: border-box;
    }
    
    .form-button {
        background-color: #4a6fa5;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    
    .form-button:hover {
        background-color: #3a5a85;
    }
    
    .close-button {
        padding: 0.75rem 1.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
        color: #666;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .close-button:hover {
        background-color: #f5f5f5;
        border-color: #bbb;
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
        .modal-content {
            width: 95%;
            margin: 10% auto;
        }
    }
</style>

<script>
    // 自定义工作流模态框管理
    document.addEventListener('DOMContentLoaded', function() {
        const workflowModal = document.getElementById('workflowModal');
        const closeBtns = workflowModal.querySelectorAll('.close, .close-button');
        const workflowTypeSelect = document.getElementById('workflowType');
        const workflowPresetsSelect = document.getElementById('workflowPresets');
        const workflowJsonTextarea = document.getElementById('workflowJson');
        const jsonError = document.getElementById('jsonError');
        
        let currentWorkflowType = '';
        
        // 关闭模态框
        function closeModal() {
            workflowModal.style.display = 'none';
            // 重置表单
            workflowJsonTextarea.value = '';
            jsonError.style.display = 'none';
            updateWorkflowPresets('');
        }
        
        // 更新工作流预设下拉框
        async function updateWorkflowPresets(type) {
            if (!type) {
                workflowPresetsSelect.innerHTML = '<option value="">-- 请选择工作流 --</option>';
                return;
            }
            
            try {
                // 显示加载状态
                workflowPresetsSelect.innerHTML = '<option value="">加载中...</option>';
                
                // 调用API获取工作流预设列表
                const response = await fetch(`/workflows/preset/list?type=${type}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const presets = await response.json();
                    
                    // 更新下拉框，直接添加默认工作流选项并设为默认选中
                    workflowPresetsSelect.innerHTML = '';
                    
                    // 添加默认工作流选项
                    const defaultOption = document.createElement('option');
                    defaultOption.value = 'default';
                    defaultOption.textContent = '默认工作流';
                    defaultOption.selected = true;
                    workflowPresetsSelect.appendChild(defaultOption);
                    
                    if (presets && presets.length > 0) {
                        presets.forEach(preset => {
                            const option = document.createElement('option');
                            option.value = preset;
                            option.textContent = preset;
                            workflowPresetsSelect.appendChild(option);
                        });
                    }
                } else {
                    workflowPresetsSelect.innerHTML = '<option value="">加载失败，请刷新页面重试</option>';
                }
            } catch (error) {
                console.error('获取工作流预设列表失败:', error);
                workflowPresetsSelect.innerHTML = '<option value="">加载失败，请刷新页面重试</option>';
            }
        }
        
        // 验证工作流中的必要节点
        function validateWorkflowNodes(jsonObj, type) {
            // 根据不同的工作流类型定义必要的节点
            const requiredNodes = {
                'text_to_image': ['CLIPTextEncode', 'KSampler', 'VAEDecode'],
                'image_to_image': ['LoadImage', 'ControlNetApply', 'KSampler', 'VAEDecode'],
                'text_to_audio': ['AudioGenerator', 'AudioEncode'],
                'text_to_video': ['KSampler', 'SaveVideo'],
                'image_to_video': ['LoadImage', 'ImageToVideo', 'VideoEncode']
            };
            
            // 检查是否是对象类型
            if (!jsonObj || typeof jsonObj !== 'object') {
                return { valid: false, message: '工作流配置必须是有效的JSON对象' };
            }
            
            // 检查是否包含节点定义
            if (!jsonObj.nodes || !Array.isArray(jsonObj.nodes)) {
                return { valid: false, message: '工作流配置必须包含nodes数组' };
            }
            
            // 获取当前类型的必要节点列表
            const currentRequiredNodes = requiredNodes[type] || [];
            const missingNodes = [];
            
            // 检查必要节点是否存在
            if (currentRequiredNodes.length > 0) {
                // 收集所有节点类型
                const nodeTypes = new Set();
                jsonObj.nodes.forEach(node => {
                    if (node.class_type) {
                        nodeTypes.add(node.class_type);
                    }else if (node.type) {
                        nodeTypes.add(node.type);
                    }
                });
                
                // 检查必要节点
                currentRequiredNodes.forEach(nodeType => {
                    if (!nodeTypes.has(nodeType)) {
                        missingNodes.push(nodeType);
                    }
                });
                
                if (missingNodes.length > 0) {
                    return { 
                        valid: false, 
                        message: `缺少必要的节点类型: ${missingNodes.join(', ')}` 
                    };
                }
            }
            
            // 检查连接关系（宽松验证，尽量不要阻止有效的工作流）
            if (jsonObj.links && Array.isArray(jsonObj.links)) {
                // 遍历每个link，只在明显有问题时报错
                for (let i = 0; i < jsonObj.links.length; i++) {
                    const link = jsonObj.links[i];
                    
                    // 如果link不是对象，跳过验证
                    if (!link || typeof link !== 'object') {
                        continue;
                    }
                    
                    // 添加调试日志，输出连接对象的内容
                    console.log(`验证连接 ${i}:`, link);
                    
                    // 检查是否有任何形式的源和目标信息
                    // 这里采用宽松的验证方式，只要有任何一种源和目标的表示方式存在，就认为有效
                    const hasAnySourceInfo = link.source !== undefined || 
                                           link.sourceNode !== undefined || 
                                           link.from !== undefined ||
                                           // 检查是否有其他可能的源表示方式
                                           'sourceId' in link ||
                                           'nodeId' in link;
                    
                    const hasAnyTargetInfo = link.target !== undefined || 
                                           link.targetNode !== undefined || 
                                           link.to !== undefined ||
                                           // 检查是否有其他可能的目标表示方式
                                           'targetId' in link ||
                                           'nextNodeId' in link;
                    
                    // 只有当完全没有源或目标信息时才报错
                    if (!hasAnySourceInfo || !hasAnyTargetInfo) {
                        console.warn(`连接${i}信息不完整，但尝试继续:`, link);
                        // 不直接返回错误，而是继续验证其他连接
                        // 可以选择记录警告但允许提交
                        continue;
                    }
                }
            }
            
            // 工作流通过基本验证
            return { valid: true };
        }
        
        // 保存工作流（通用函数）
        async function saveWorkflow(applyAfterSave = false) {
            const jsonStr = workflowJsonTextarea.value.trim();
            const selectedPreset = workflowPresetsSelect.value;
            
            // 如果选择的是默认工作流且点击了应用按钮，根据文本框内容决定是应用还是清空
            if (selectedPreset === 'default' && applyAfterSave) {
                // 获取当前操作的按钮并禁用
                const saveOnlyBtn = document.getElementById('saveWorkflowOnlyBtn');
                const saveAndApplyBtn = document.getElementById('saveAndApplyWorkflowBtn');
                const originalText1 = saveOnlyBtn.textContent;
                const originalText2 = saveAndApplyBtn.textContent;
                
                saveOnlyBtn.disabled = true;
                saveAndApplyBtn.disabled = true;
                saveOnlyBtn.textContent = '保存中...';
                saveAndApplyBtn.textContent = '保存中...';
                
                try {
                    // 检查文本框中是否有内容
                    if (jsonStr) {
                        // 文本框有内容，验证并包装JSON，然后先保存为文件，再应用文件名
                        try {
                            const jsonObj = JSON.parse(jsonStr);
                            
                            // 验证工作流节点结构
                            const nodeValidation = validateWorkflowNodes(jsonObj, currentWorkflowType);
                            if (!nodeValidation.valid) {
                                jsonError.textContent = nodeValidation.message;
                                jsonError.style.display = 'block';
                                return;
                            }
                            
                            // 包装JSON：添加prompt、client_id、extra_data节点
                            const clientId = 'hengline-' + Date.now().toString(36) + Math.random().toString(36).substr(2);
                            
                            const wrappedJsonObj = {
                                client_id: clientId,
                                prompt: jsonObj,
                                extra_data: {
                                    groups: [],
                                    config: {},
                                    extra: {
                                        ds: {
                                            scale: 0.6734062593544803,
                                            offset: [
                                                -219.35580451797807,
                                                53.27316285543402
                                            ]
                                        },
                                        frontendVersion: '1.25.11'
                                    },
                                    version: 0.4
                                }
                            };
                            
                            const wrappedJsonStr = JSON.stringify(wrappedJsonObj, null, 2);
                            
                            // 先保存为文件
                            const saveBody = {
                                type: currentWorkflowType,
                                json: wrappedJsonStr
                            };
                            
                            const saveResponse = await fetch('/workflows/preset/save', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: JSON.stringify(saveBody)
                            });
                            
                            if (saveResponse.ok) {
                                const saveResult = await saveResponse.json();
                                if (saveResult.success) {
                                    // 获取保存的文件名
                                    const newFileName = saveResult.workflowName;
                                    
                                    // 构建应用工作流的请求数据（使用保存的文件名）
                                    const setRequestData = {
                                        type: currentWorkflowType,
                                        workflow: newFileName
                                    };
                                    
                                    console.log('应用工作流文件:', setRequestData);
                                    
                                    const applyResponse = await fetch('/workflows/preset/set', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-Requested-With': 'XMLHttpRequest'
                                        },
                                        body: JSON.stringify(setRequestData)
                                    });
                                    
                                    if (applyResponse.ok) {
                                        const applyResult = await applyResponse.json();
                                        if (applyResult.success) {
                                            // 显示成功消息
                                            if (window.showAutoCloseNotification) {
                                                window.showAutoCloseNotification('工作流文件已保存并应用', 'success', 3000);
                                            } else {
                                                alert('工作流文件已保存并应用');
                                            }
                                        } else {
                                            jsonError.textContent = `应用工作流失败: ${applyResult.message || '未知错误'}`;
                                            jsonError.style.display = 'block';
                                        }
                                    } else {
                                        jsonError.textContent = '应用工作流失败，请重试';
                                        jsonError.style.display = 'block';
                                    }
                                } else {
                                    jsonError.textContent = `保存工作流失败: ${saveResult.message || '未知错误'}`;
                                    jsonError.style.display = 'block';
                                }
                            } else {
                                jsonError.textContent = '保存工作流失败，请重试';
                                jsonError.style.display = 'block';
                            }
                        } catch (jsonError) {
                            jsonError.textContent = `JSON格式错误: ${jsonError.message}`;
                            jsonError.style.display = 'block';
                        }
                    } else {
                        // 文本框没有内容，清空workflow节点值
                        const setRequestData = {
                            type: currentWorkflowType,
                            workflow: ''
                        };
                        
                        console.log('清空workflow节点值:', setRequestData);
                        
                        const applyResponse = await fetch('/workflows/preset/set', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify(setRequestData)
                        });
                        
                        if (applyResponse.ok) {
                            const applyResult = await applyResponse.json();
                            if (applyResult.success) {
                                // 显示成功消息
                                if (window.showAutoCloseNotification) {
                                    window.showAutoCloseNotification('工作流已清空', 'success', 3000);
                                } else {
                                    alert('工作流已清空');
                                }
                            } else {
                                jsonError.textContent = `清空工作流失败: ${applyResult.message || '未知错误'}`;
                                jsonError.style.display = 'block';
                            }
                        } else {
                            jsonError.textContent = '清空工作流失败，请重试';
                            jsonError.style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error('操作工作流失败:', error);
                    jsonError.textContent = `操作工作流失败: ${error.message}`;
                    jsonError.style.display = 'block';
                } finally {
                    // 恢复按钮状态
                    saveOnlyBtn.disabled = false;
                    saveAndApplyBtn.disabled = false;
                    saveOnlyBtn.textContent = originalText1;
                    saveAndApplyBtn.textContent = originalText2;
                }
                
                // 关闭模态框
                closeModal();
                
                return;
            }
            
            // 验证JSON格式
            if (!jsonStr) {
                jsonError.textContent = '请输入工作流JSON配置';
                jsonError.style.display = 'block';
                return;
            }
            
            try {
                const jsonObj = JSON.parse(jsonStr);
                jsonError.style.display = 'none';
                
                // 验证工作流节点结构
                const nodeValidation = validateWorkflowNodes(jsonObj, currentWorkflowType);
                if (!nodeValidation.valid) {
                    jsonError.textContent = nodeValidation.message;
                    jsonError.style.display = 'block';
                    return;
                }
                
                // 包装JSON：添加prompt、client_id、extra_data节点
                // 生成唯一的client_id
                const clientId = 'hengline-' + Date.now().toString(36) + Math.random().toString(36).substr(2);
                
                // 构建包装后的JSON对象
                const wrappedJsonObj = {
                    client_id: clientId,
                    prompt: jsonObj,
                    extra_data: {
                        groups: [],
                        config: {},
                        extra: {
                            ds: {
                                scale: 0.6734062593544803,
                                offset: [
                                    -219.35580451797807,
                                    53.27316285543402
                                ]
                            },
                            frontendVersion: '1.25.11'
                        },
                        version: 0.4
                    }
                };
                
                // 转换回字符串
                const wrappedJsonStr = JSON.stringify(wrappedJsonObj, null, 2);
                
                console.log('包装后的工作流JSON:', wrappedJsonObj);
            } catch (error) {
                jsonError.textContent = `JSON格式错误: ${error.message}`;
                jsonError.style.display = 'block';
                return;
            }
            
            // 获取当前操作的按钮并禁用
            const saveOnlyBtn = document.getElementById('saveWorkflowOnlyBtn');
            const saveAndApplyBtn = document.getElementById('saveAndApplyWorkflowBtn');
            const originalText1 = saveOnlyBtn.textContent;
            const originalText2 = saveAndApplyBtn.textContent;
            
            saveOnlyBtn.disabled = true;
            saveAndApplyBtn.disabled = true;
            saveOnlyBtn.textContent = '保存中...';
            saveAndApplyBtn.textContent = '保存中...';
            
            try {
                // 获取当前选中的工作流名称
                const selectedPreset = workflowPresetsSelect.value;
                
                // 判断是否需要新增工作流（下拉框没选择或选择的是默认工作流）
                const shouldCreateNew = !selectedPreset || selectedPreset === 'default';
                
                // 调用API保存工作流
                const saveBody = {
                    type: currentWorkflowType,
                    json: wrappedJsonStr
                };
                
                // 如果不是新增工作流，则添加name字段用于更新
                if (!shouldCreateNew) {
                    saveBody.name = selectedPreset;
                }
                
                const response = await fetch('/workflows/preset/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(saveBody)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        let notificationMessage = '工作流保存成功！';
                        
                        // 如果需要应用工作流
                        if (applyAfterSave) {
                            try {
                                // 调用API应用工作流到workflow_presets.json的workflow节点
                                // 使用完整的工作流名称
                                let workflowValue;
                                let newWorkflowName = '';
                                
                                if (shouldCreateNew) {
                                    // 对于新创建的工作流，使用返回的workflowName
                                    workflowValue = result.workflowName;
                                    newWorkflowName = result.workflowName;
                                } else {
                                    // 对于现有工作流，使用选择的名称
                                    workflowValue = selectedPreset;
                                }
                                
                                console.log('应用工作流:', workflowValue);
                                console.log('保存结果:', result);
                                
                                // 构建应用工作流的请求数据
                                // 确保使用完整的文件名，以便更新到workflow_presets.json的workflow节点
                                const setRequestData = {
                                    type: currentWorkflowType,
                                    workflow: workflowValue
                                };
                                console.log('构建的应用工作流请求数据:', setRequestData);
                                console.log('准备发送的应用工作流请求数据:', setRequestData);
                                
                                try {
                                    const applyResponse = await fetch('/workflows/preset/set', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-Requested-With': 'XMLHttpRequest'
                                        },
                                        body: JSON.stringify(setRequestData)
                                    });
                                    
                                    console.log('应用工作流请求状态:', applyResponse.status);
                                    
                                    if (applyResponse.ok) {
                                        try {
                                            const applyResult = await applyResponse.json();
                                            console.log('应用结果详情:', applyResult);
                                            console.log('发送的工作流名称:', workflowValue);
                                            console.log('发送的工作流类型:', currentWorkflowType);
                                             
                                            if (applyResult.success) {
                                                notificationMessage = '工作流保存并应用成功！';
                                                console.log('工作流已成功应用到配置文件');
                                                 
                                                // 如果是新创建的工作流，更新下拉框并选中它
                                                if (shouldCreateNew && newWorkflowName) {
                                                    console.log('更新工作流预设下拉框并选中新创建的工作流:', newWorkflowName);
                                                     
                                                    // 创建一个异步函数来更新下拉框
                                                    (async function() {
                                                        try {
                                                            await updateWorkflowPresets(currentWorkflowType);
                                                             
                                                            // 等待DOM更新
                                                            setTimeout(() => {
                                                                // 选中新创建的工作流
                                                                for (let i = 0; i < workflowPresetsSelect.options.length; i++) {
                                                                    if (workflowPresetsSelect.options[i].value === newWorkflowName) {
                                                                        workflowPresetsSelect.selectedIndex = i;
                                                                        break;
                                                                    }
                                                                }
                                                            }, 100);
                                                        } catch (error) {
                                                            console.error('更新工作流预设下拉框失败:', error);
                                                        }
                                                    })();
                                                }
                                            } else {
                                                notificationMessage = `工作流保存成功，但应用失败: ${applyResult.message || '未知错误'}`;
                                                console.error('应用工作流失败 - 后端返回错误:', applyResult);
                                            }
                                        } catch (jsonError) {
                                            notificationMessage = '工作流保存成功，但无法解析应用响应结果';
                                            console.error('解析应用工作流响应失败:', jsonError);
                                        }
                                    } else {
                                        notificationMessage = `工作流保存成功，但应用请求失败: HTTP ${applyResponse.status}`;
                                        console.error('应用工作流请求失败:', applyResponse.statusText);
                                    }
                                } catch (fetchError) {
                                    notificationMessage = `工作流保存成功，但应用请求发生异常: ${fetchError.message}`;
                                    console.error('应用工作流请求异常:', fetchError);
                                }
                                

                            } catch (error) {
                                console.error('应用工作流失败:', error);
                                notificationMessage = `工作流保存成功，但应用失败: ${error.message}`;
                            }
                        }
                        
                        // 显示成功消息
                        if (window.showAutoCloseNotification) {
                            window.showAutoCloseNotification(notificationMessage, 'success', 3000);
                        } else {
                            alert(notificationMessage);
                        }
                        
                        // 关闭模态框
                        closeModal();
                        
                        // 更新工作流预设下拉框
                        await updateWorkflowPresets(currentWorkflowType);
                    } else {
                        jsonError.textContent = `保存失败: ${result.message || '未知错误'}`;
                        jsonError.style.display = 'block';
                    }
                } else {
                    jsonError.textContent = '保存失败，请重试';
                    jsonError.style.display = 'block';
                }
            } catch (error) {
                console.error('保存工作流失败:', error);
                jsonError.textContent = `保存失败: ${error.message}`;
                jsonError.style.display = 'block';
            } finally {
                // 恢复按钮状态
                saveOnlyBtn.disabled = false;
                saveAndApplyBtn.disabled = false;
                saveOnlyBtn.textContent = originalText1;
                saveAndApplyBtn.textContent = originalText2;
            }
        }
        
        // 仅保存工作流
        function saveWorkflowOnly() {
            saveWorkflow(false);
        }
        
        // 保存并应用工作流
        function saveAndApplyWorkflow() {
            saveWorkflow(true);
        }
        
        // 选择工作流预设
        async function selectWorkflowPreset() {
            const selectedPreset = workflowPresetsSelect.value;
            
            // 检查是否是通过打开模态框自动触发的事件
            const isAutoTriggered = event && event.isTrusted === false;
            
            if (!selectedPreset) {
                // 只有在用户主动选择的情况下才清空workflow字段
                if (!isAutoTriggered) {
                    try {
                        await fetch('/workflows/preset/set', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                type: currentWorkflowType,
                                workflow: ''
                            })
                        });
                        
                        // 清空JSON文本框
                        workflowJsonTextarea.value = '';
                        
                        if (window.showAutoCloseNotification) {
                            window.showAutoCloseNotification('已清空当前工作流配置', 'info', 2000);
                        }
                    } catch (error) {
                        console.error('清空工作流配置失败:', error);
                    }
                } else {
                    // 自动触发事件时，只清空文本框但不清空workflow字段
                    workflowJsonTextarea.value = '';
                }
                return;
            }
            
            // 如果选择的是默认工作流
            if (selectedPreset === 'default') {
                try {
                    // 只有在用户主动选择的情况下才清空workflow字段
                    if (!isAutoTriggered) {
                        await fetch('/workflows/preset/set', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                type: currentWorkflowType,
                                workflow: ''
                            })
                        });
                    }
                    
                    // 清空JSON文本框，让用户可以输入新的工作流配置
                    workflowJsonTextarea.value = '';
                    
                    // if (window.showAutoCloseNotification) {
                    //     window.showAutoCloseNotification('请在输入框中编辑工作流配置，保存时将创建新工作流', 'info', 3000);
                    // }
                } catch (error) {
                    console.error('设置默认工作流失败:', error);
                    if (window.showAutoCloseNotification) {
                        window.showAutoCloseNotification('设置默认工作流失败，请重试', 'error', 3000);
                    }
                }
                return;
            }
            
            // 显示加载状态
            workflowPresetsSelect.disabled = true;
            
            try {
                // 调用API获取工作流详情
                const response = await fetch(`/workflows/preset/get?type=${currentWorkflowType}&name=${encodeURIComponent(selectedPreset)}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // 设置workflow字段
                        try {
                            await fetch('/workflows/preset/set', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: JSON.stringify({
                                    type: currentWorkflowType,
                                    workflow: selectedPreset
                                })
                            });
                            
                            // 填充JSON到文本框
                            workflowJsonTextarea.value = JSON.stringify(result.json, null, 2);
                            
                            // 显示成功消息
                            if (window.showAutoCloseNotification) {
                                window.showAutoCloseNotification('工作流已加载并应用', 'success', 2000);
                            }
                        } catch (error) {
                            console.error('设置工作流配置失败:', error);
                            if (window.showAutoCloseNotification) {
                                window.showAutoCloseNotification('应用工作流失败，请重试', 'error', 3000);
                            }
                        }
                    } else {
                        if (window.showAutoCloseNotification) {
                            window.showAutoCloseNotification(`加载工作流失败: ${result.message || '未知错误'}`, 'error', 3000);
                        }
                    }
                } else {
                    if (window.showAutoCloseNotification) {
                        window.showAutoCloseNotification('加载工作流失败，请重试', 'error', 3000);
                    }
                }
            } catch (error) {
                console.error('加载工作流失败:', error);
                if (window.showAutoCloseNotification) {
                    window.showAutoCloseNotification(`加载工作流失败: ${error.message}`, 'error', 3000);
                }
            } finally {
                // 恢复下拉框状态
                workflowPresetsSelect.disabled = false;
            }
        }
        
        // 打开工作流模态框
        window.openWorkflowModal = async function(type) {
            currentWorkflowType = type;
            
            // 设置工作流类型
            workflowTypeSelect.value = type;
            
            // 更新工作流预设下拉框
            await updateWorkflowPresets(type);
            
            try {
                // 获取当前工作流类型的配置
                const configResponse = await fetch(`/workflows/preset/get_current?type=${type}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (configResponse.ok) {
                    const configResult = await configResponse.json();
                    if (configResult.success && configResult.workflow) {
                        // 如果workflow节点有值，选中对应的工作流
                        workflowPresetsSelect.value = configResult.workflow;
                        // 创建自定义事件，标记为自动触发
                        const autoEvent = new Event('change');
                        autoEvent.isTrusted = false; // 标记为自动触发的事件
                        // 触发选择事件
                        workflowPresetsSelect.dispatchEvent(autoEvent);
                    } else {
                        // 如果workflow节点没有值，选中默认工作流
                        workflowPresetsSelect.value = 'default';
                        // 创建自定义事件，标记为自动触发
                        const autoEvent = new Event('change');
                        autoEvent.isTrusted = false; // 标记为自动触发的事件
                        // 触发选择事件
                        workflowPresetsSelect.dispatchEvent(autoEvent);
                    }
                }
            } catch (error) {
                console.error('获取当前工作流配置失败:', error);
                // 出错时默认选中默认工作流
                workflowPresetsSelect.value = 'default';
            }
            
            // 显示模态框
            workflowModal.style.display = 'block';
        }
        
        // 绑定关闭事件
        closeBtns.forEach(btn => {
            btn.addEventListener('click', closeModal);
        });
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target === workflowModal) {
                closeModal();
            }
        });
        
        // 绑定保存事件
        document.getElementById('saveWorkflowOnlyBtn').addEventListener('click', saveWorkflowOnly);
        document.getElementById('saveAndApplyWorkflowBtn').addEventListener('click', saveAndApplyWorkflow);
        
        // 绑定工作流预设选择事件
        workflowPresetsSelect.addEventListener('change', selectWorkflowPreset);
        
        // ESC键关闭模态框
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && workflowModal.style.display === 'block') {
                closeModal();
            }
        });
    });
</script>